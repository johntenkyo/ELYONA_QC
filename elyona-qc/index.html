<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELYONA灯具质检系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 添加Supabase客户端库 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .logo i {
            color: #3498db;
        }
        
        .app-version {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 12px;
            opacity: 0.7;
        }
        
        .nav-tabs {
            display: flex;
            background: #34495e;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            min-height: 500px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }
        
        .btn {
            display: inline-block;
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
            height: 38px;
            line-height: 18px;
        }
        
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-success {
            background: #2ecc71;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-warning {
            background: #f39c12;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        
        .card h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .photo-upload-area {
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin: 15px 0;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .photo-upload-area:hover {
            background: #e3f2fd;
        }
        
        .photo-upload-area i {
            font-size: 24px;
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .photo-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .photo-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-item .remove {
            position: absolute;
            top: 3px;
            right: 3px;
            background: rgba(231, 76, 60, 0.8);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }
        
        .sample-items {
            margin-top: 20px;
        }
        
        .sample-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #2ecc71;
        }
        
        .sample-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .sample-title {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .sample-result {
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 4px;
        }
        
        .sample-result.pass {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .sample-result.fail {
            background: #fadbd8;
            color: #e74c3c;
        }
        
        .history-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #3498db;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .history-checkbox {
            width: 20px;
            height: 20px;
        }
        
        .history-content {
            flex: 1;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .history-title {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .history-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .badge-danger {
            background: #fadbd8;
            color: #e74c3c;
        }
        
        .badge-warning {
            background: #fdebd0;
            color: #f39c12;
        }
        
        .hidden {
            display: none;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-success {
            color: #2ecc71;
        }
        
        .stat-danger {
            color: #e74c3c;
        }
        
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .chart-container {
            height: 300px;
            margin: 20px 0;
            position: relative;
            overflow-x: auto;
        }
        
        .chart-wrapper {
            min-width: 600px;
            height: 100%;
        }
        
        .history-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: auto;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .signature-area {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        
        .signature-line {
            display: inline-block;
            width: 200px;
            border-bottom: 1px solid #333;
            margin-right: 30px;
            padding-bottom: 5px;
        }
        
        .time-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .issue-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .issue-list {
            list-style: none;
        }
        
        .issue-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .issue-name {
            font-weight: 500;
        }
        
        .issue-count {
            font-weight: bold;
        }
        
        .return-rate-history {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
        }
        
        .return-rate-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f5f5f5;
        }
        
        .return-rate-item:last-child {
            border-bottom: none;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        /* 报告样式 */
        .report-photos {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .report-photo-item {
            width: 150px;
            height: 150px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .report-photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* 打印样式 */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-section, .print-section * {
                visibility: visible;
            }
            .print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
            }
            .no-print {
                display: none !important;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                border-radius: 10px;
            }
            
            .stats, .issue-stats {
                grid-template-columns: 1fr;
            }
            
            .history-details {
                grid-template-columns: 1fr;
            }
            
            .history-actions {
                flex-direction: column;
            }
            
            .time-selector {
                grid-template-columns: 1fr;
            }
        }

        /* 新添加的样式 */
        .upload-progress {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
            display: none;
        }
        
        .upload-progress-bar {
            height: 100%;
            background: #3498db;
            width: 0%;
            transition: width 0.3s;
        }
        
        .photo-count {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .compression-info {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .photo-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .clear-photos-btn {
            background: #e74c3c;
        }
        
        .clear-photos-btn:hover {
            background: #c0392b;
        }
        
        /* 不合格数量输入框样式 */
        .defect-quantity {
            margin-top: 10px;
            display: none;
        }
        
        .defect-quantity.visible {
            display: block;
        }
        
        .defect-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        /* 数据库连接状态 */
        .db-status {
            position: absolute;
            top: 10px;
            left: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .db-connected {
            color: #2ecc71;
        }
        
        .db-disconnected {
            color: #e74c3c;
        }
        
        /* 添加滚动条样式 */
        .chart-container::-webkit-scrollbar {
            height: 8px;
        }
        
        .chart-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .chart-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .chart-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* 添加退货率趋势图容器样式 */
        .return-rate-full-container {
            position: relative;
            overflow: hidden;
        }
        
        .chart-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .chart-note {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-lightbulb"></i>
                ELYONA灯具质检系统
            </div>
            <div class="app-version">v2.6.0 (云端版)</div>
            <div class="db-status" id="db-status">
                <i class="fas fa-database"></i>
                <span>连接中...</span>
            </div>
        </header>
        
        <div class="nav-tabs">
            <div class="tab active" data-tab="full-inspection">全检</div>
            <div class="tab" data-tab="sampling-inspection">抽检</div>
            <div class="tab" data-tab="history">历史记录</div>
            <div class="tab" data-tab="stats">数据统计</div>
        </div>
        
        <!-- 全检标签内容 -->
        <div class="tab-content active" id="full-inspection">
            <h2>全检验货</h2>
            <p>对产品进行100%全面检查，确保每个产品符合质量标准。</p>
            
            <div class="card">
                <h3><i class="fas fa-info-circle"></i> 产品信息</h3>
                <div class="form-group">
                    <label for="full-product-sku">产品SKU</label>
                    <input type="text" id="full-product-sku" placeholder="例如: ELY-WD-001">
                </div>
                <div class="form-group">
                    <label for="full-batch-no">批次号</label>
                    <input type="text" id="full-batch-no" placeholder="例如: B2023102001">
                </div>
                <div class="form-group">
                    <label for="full-inspection-quantity">全检产品数量</label>
                    <input type="number" id="full-inspection-quantity" placeholder="请输入全检产品数量" min="1">
                </div>
                <div class="form-group">
                    <label for="full-inspector">检验员</label>
                    <input type="text" id="full-inspector" placeholder="请输入检验员姓名">
                </div>
                <div class="time-selector">
                    <div class="form-group">
                        <label for="full-date">检验日期</label>
                        <input type="date" id="full-date">
                    </div>
                    <div class="form-group">
                        <label for="full-time">检验时间</label>
                        <input type="time" id="full-time">
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-clipboard-check"></i> 检验项目</h3>
                <div class="form-group">
                    <label for="full-color-check">颜色色差</label>
                    <select id="full-color-check">
                        <option value="合格">合格 - 与标准样品一致</option>
                        <option value="不合格">不合格 - 存在明显色差</option>
                    </select>
                    <div class="defect-quantity" id="full-color-defect">
                        <label>不合格产品数量</label>
                        <input type="number" class="defect-input" id="full-color-defect-quantity" min="0" placeholder="请输入不合格产品数量">
                    </div>
                </div>
                <div class="form-group">
                    <label for="full-scratch-check">表面划痕</label>
                    <select id="full-scratch-check">
                        <option value="合格">合格 - 表面无划痕</option>
                        <option value="不合格">不合格 - 表面有明显划痕</option>
                    </select>
                    <div class="defect-quantity" id="full-scratch-defect">
                        <label>不合格产品数量</label>
                        <input type="number" class="defect-input" id="full-scratch-defect-quantity" min="0" placeholder="请输入不合格产品数量">
                    </div>
                </div>
                <div class="form-group">
                    <label for="full-parts-check">配件完整性</label>
                    <select id="full-parts-check">
                        <option value="合格">合格 - 所有配件齐全</option>
                        <option value="不合格">不合格 - 缺失配件</option>
                    </select>
                    <div class="defect-quantity" id="full-parts-defect">
                        <label>不合格产品数量</label>
                        <input type="number" class="defect-input" id="full-parts-defect-quantity" min="0" placeholder="请输入不合格产品数量">
                    </div>
                </div>
                <div class="form-group">
                    <label for="full-function-check">功能结构正确</label>
                    <select id="full-function-check">
                        <option value="合格">合格 - 功能结构正常</option>
                        <option value="不合格">不合格 - 功能结构问题</option>
                    </select>
                    <div class="defect-quantity" id="full-function-defect">
                        <label>不合格产品数量</label>
                        <input type="number" class="defect-input" id="full-function-defect-quantity" min="0" placeholder="请输入不合格产品数量">
                    </div>
                </div>
                <div class="form-group">
                    <label for="full-packaging-check">包装检查</label>
                    <select id="full-packaging-check">
                        <option value="合格">合格 - 包装完好，标签正确</option>
                        <option value="不合格">不合格 - 包装或标签问题</option>
                    </select>
                    <div class="defect-quantity" id="full-packaging-defect">
                        <label>不合格产品数量</label>
                        <input type="number" class="defect-input" id="full-packaging-defect-quantity" min="0" placeholder="请输入不合格产品数量">
                    </div>
                </div>
                <div class="form-group">
                    <label for="full-other-check">其他问题</label>
                    <select id="full-other-check">
                        <option value="合格">合格 - 无其他问题</option>
                        <option value="不合格">不合格 - 存在其他问题</option>
                    </select>
                    <div class="defect-quantity" id="full-other-defect">
                        <label>不合格产品数量</label>
                        <input type="number" class="defect-input" id="full-other-defect-quantity" min="0" placeholder="请输入不合格产品数量">
                    </div>
                </div>
                <div class="form-group">
                    <label for="full-notes">检验备注</label>
                    <textarea id="full-notes" rows="3" placeholder="记录检验过程中的特殊情况..."></textarea>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-camera"></i> 不合格产品照片</h3>
                <p>上传不合格产品照片，包括整体、细节和问题部位。</p>
                <p class="compression-info">照片将自动压缩以节省存储空间，仅用于临时打印</p>
                
                <div class="photo-upload-area" id="full-upload-area">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>点击上传不合格产品照片</p>
                    <p class="small">支持 JPG、PNG 格式，无数量限制</p>
                    <input type="file" id="full-photo-input" accept="image/*" multiple class="hidden">
                </div>
                
                <div class="upload-progress" id="full-upload-progress">
                    <div class="upload-progress-bar" id="full-progress-bar"></div>
                </div>
                
                <div class="photo-preview" id="full-photo-preview">
                    <!-- 照片预览将在这里显示 -->
                </div>
                <div class="photo-count" id="full-photo-count">已上传 0 张照片</div>
                
                <div class="photo-actions">
                    <button class="btn clear-photos-btn" id="clear-full-photos">
                        <i class="fas fa-trash"></i> 清除所有照片
                    </button>
                </div>
            </div>
            
            <!-- 调整按钮顺序 -->
            <button class="btn btn-block" id="print-full-report">
                <i class="fas fa-print"></i> 打印报告 (包含当前照片)
            </button>
            
            <button class="btn btn-warning btn-block" id="export-full-word">
                <i class="fas fa-file-word"></i> 导出Word报告 (包含当前照片)
            </button>
            
            <button class="btn btn-success btn-block" id="save-full-inspection">
                <i class="fas fa-save"></i> 保存全检记录 (不包含照片)
            </button>
            
            <!-- 添加同步到云端按钮 -->
            <button class="btn btn-block" id="sync-full-to-cloud" style="margin-top: 10px; background: #9b59b6;">
                <i class="fas fa-cloud-upload-alt"></i> 同步到云端数据库
            </button>
        </div>
        
        <!-- 抽检标签内容 -->
        <div class="tab-content" id="sampling-inspection">
            <h2>抽检验货</h2>
            <p>根据AQL标准进行抽样检验，自动计算抽样数量。</p>
            
            <div class="card">
                <h3><i class="fas fa-info-circle"></i> 产品信息</h3>
                <div class="form-group">
                    <label for="sample-product-sku">产品SKU</label>
                    <input type="text" id="sample-product-sku" placeholder="例如: ELY-FL-002">
                </div>
                <div class="form-group">
                    <label for="sample-batch-no">批次号</label>
                    <input type="text" id="sample-batch-no" placeholder="例如: B2023102002">
                </div>
                <div class="form-group">
                    <label for="sample-lot-size">批次数量</label>
                    <input type="number" id="sample-lot-size" placeholder="请输入本批次产品总数">
                </div>
                <div class="form-group">
                    <label for="sample-inspector">检验员</label>
                    <input type="text" id="sample-inspector" placeholder="请输入检验员姓名">
                </div>
                <div class="time-selector">
                    <div class="form-group">
                        <label for="sample-date">检验日期</label>
                        <input type="date" id="sample-date">
                    </div>
                    <div class="form-group">
                        <label for="sample-time">检验时间</label>
                        <input type="time" id="sample-time">
                    </div>
                </div>
                <div class="form-group">
                    <label for="sample-aql">AQL标准</label>
                    <select id="sample-aql">
                        <option value="1.0">AQL 1.0 (严格)</option>
                        <option value="2.5" selected>AQL 2.5 (正常)</option>
                        <option value="4.0">AQL 4.0 (宽松)</option>
                    </select>
                </div>
                
                <button class="btn" id="calculate-sample">
                    <i class="fas fa-calculator"></i> 计算抽样数量
                </button>
                
                <div class="form-group" id="sample-result" style="display: none;">
                    <div class="card" style="background: #e8f4fc; margin-top: 15px;">
                        <h4>抽样计划</h4>
                        <p>样本数量: <span id="sample-size">0</span></p>
                        <p>允收数(Ac): <span id="acceptance-number">0</span></p>
                        <p>拒收数(Re): <span id="rejection-number">0</span></p>
                    </div>
                </div>
            </div>
            
            <div class="card" id="sample-items-container" style="display: none;">
                <h3><i class="fas fa-boxes"></i> 样本检查</h3>
                <p>对每个样本进行检查并记录结果。</p>
                
                <div class="sample-items" id="sample-items">
                    <!-- 样本项目将在这里动态生成 -->
                </div>
                
                <div class="photo-actions">
                    <button class="btn clear-photos-btn" id="clear-sample-photos">
                        <i class="fas fa-trash"></i> 清除所有样本照片
                    </button>
                </div>
            </div>
            
            <!-- 调整按钮顺序 -->
            <button class="btn btn-block" id="print-sample-report">
                <i class="fas fa-print"></i> 打印报告 (包含当前照片)
            </button>
            
            <button class="btn btn-warning btn-block" id="export-sample-word">
                <i class="fas fa-file-word"></i> 导出Word报告 (包含当前照片)
            </button>
            
            <button class="btn btn-success btn-block" id="save-sample-inspection">
                <i class="fas fa-save"></i> 保存抽检记录 (不包含照片)
            </button>
            
            <!-- 添加同步到云端按钮 -->
            <button class="btn btn-block" id="sync-sample-to-cloud" style="margin-top: 10px; background: #9b59b6;">
                <i class="fas fa-cloud-upload-alt"></i> 同步到云端数据库
            </button>
        </div>
        
        <!-- 历史记录标签内容 -->
        <div class="tab-content" id="history">
            <h2>检验历史记录</h2>
            <p>查看和管理之前的检验记录，支持多选导出Excel和导入外部数据。</p>
            
            <div class="history-actions">
                <div class="form-group" style="flex: 1;">
                    <input type="text" id="search-history" placeholder="搜索产品SKU或批次号...">
                </div>
                <button class="btn" id="select-all">
                    <i class="fas fa-check-square"></i> 全选
                </button>
                <button class="btn" id="deselect-all">
                    <i class="far fa-square"></i> 取消全选
                </button>
                <button class="btn btn-success" id="export-selected">
                    <i class="fas fa-file-excel"></i> 导出选中记录
                </button>
                <div class="file-input-wrapper">
                    <button class="btn btn-warning">
                        <i class="fas fa-file-import"></i> 导入数据
                    </button>
                    <input type="file" id="import-data" accept=".xlsx,.xls">
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-database"></i> 云端数据管理</h3>
                <div class="history-actions">
                    <button class="btn" id="load-from-cloud">
                        <i class="fas fa-cloud-download-alt"></i> 从云端加载数据
                    </button>
                    <button class="btn btn-success" id="sync-all-to-cloud">
                        <i class="fas fa-cloud-upload-alt"></i> 同步所有数据到云端
                    </button>
                    <button class="btn btn-warning" id="merge-data">
                        <i class="fas fa-exchange-alt"></i> 合并云端与本地数据
                    </button>
                </div>
                <p class="chart-note">注意：云端数据是所有质检员共享的，您可以看到其他人的检验记录。</p>
            </div>
            
            <div class="history-list" id="history-list">
                <!-- 历史记录将在这里显示 -->
            </div>
            
            <div class="history-actions">
                <button class="btn" id="export-excel">
                    <i class="fas fa-file-excel"></i> 导出全部Excel
                </button>
                <button class="btn btn-danger" id="clear-history">
                    <i class="fas fa-trash"></i> 清空本地记录
                </button>
            </div>
        </div>
        
        <!-- 数据统计标签内容 -->
        <div class="tab-content" id="stats">
            <h2>质检数据统计</h2>
            <p>分析检验数据，监控质量趋势。</p>
            
            <div class="card">
                <h3><i class="fas fa-database"></i> 数据来源</h3>
                <div class="history-actions">
                    <button class="btn" id="load-stats-from-cloud">
                        <i class="fas fa-cloud-download-alt"></i> 从云端加载统计数据
                    </button>
                    <select id="data-source" style="width: auto;">
                        <option value="local">仅本地数据</option>
                        <option value="cloud" selected>云端数据（所有人共享）</option>
                    </select>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">本月质检总数</div>
                    <div class="stat-value" id="current-month-total">0</div>
                    <div class="stat-label" id="month-total-change">比上月 +0%</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">合格率</div>
                    <div class="stat-value stat-success" id="pass-rate">0%</div>
                    <div class="stat-label" id="pass-rate-change">比上月 +0%</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">不合格数量</div>
                    <div class="stat-value" id="defect-count">0</div>
                    <div class="stat-label" id="defect-count-change">比上月 +0%</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">不良率</div>
                    <div class="stat-value stat-danger" id="defect-rate">0%</div>
                    <div class="stat-label" id="defect-rate-change">比上月 +0%</div>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-chart-pie"></i> 问题统计</h3>
                <div class="issue-stats">
                    <div>
                        <ul class="issue-list" id="issue-list">
                            <!-- 问题统计列表将在这里显示 -->
                        </ul>
                    </div>
                    <div>
                        <div class="chart-container">
                            <canvas id="issueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-chart-line"></i> 退货率趋势</h3>
                <div class="chart-controls">
                    <p>全部退货率数据（可左右滑动查看）</p>
                    <div>
                        <button class="btn" id="zoom-in" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-search-plus"></i> 放大
                        </button>
                        <button class="btn" id="zoom-out" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-search-minus"></i> 缩小
                        </button>
                        <button class="btn" id="reset-zoom" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-sync-alt"></i> 重置
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-wrapper" id="return-rate-chart-wrapper" style="min-width: 1200px;">
                        <canvas id="returnRateChart"></canvas>
                    </div>
                </div>
                <p class="chart-note">提示：使用鼠标滚轮或拖动滚动条查看完整历史数据</p>
                <div class="form-group" style="display: flex; gap: 10px; margin-top: 15px;">
                    <input type="number" id="target-return-rate" min="0" max="100" step="0.1" placeholder="目标退货率 (%)" style="flex: 1;">
                    <button class="btn" id="set-target-rate">
                        <i class="fas fa-bullseye"></i> 设置目标
                    </button>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-edit"></i> 月度退货率记录</h3>
                <p>每月填写退货率数据</p>
                
                <div class="form-group">
                    <label for="return-rate-month">月份</label>
                    <input type="month" id="return-rate-month">
                </div>
                
                <div class="form-group">
                    <label for="return-rate-value">退货率 (%)</label>
                    <input type="number" id="return-rate-value" min="0" max="100" step="0.1" placeholder="输入退货率百分比">
                </div>
                
                <button class="btn btn-success" id="save-return-rate">
                    <i class="fas fa-save"></i> 保存退货率记录
                </button>
                
                <button class="btn" id="sync-return-rates" style="margin-top: 10px;">
                    <i class="fas fa-cloud-upload-alt"></i> 同步退货率到云端
                </button>
                
                <div class="form-group" style="margin-top: 20px;">
                    <h4>历史退货率记录 (全部数据)</h4>
                    <div class="return-rate-history" id="return-rate-history">
                        <!-- 退货率历史记录将在这里显示 -->
                    </div>
                    <p class="chart-note">提示：使用滚动条查看所有历史记录</p>
                </div>
            </div>
        </div>
        
        <footer>
            <p>ELYONA灯具质检系统 &copy; 2023 | 版本 2.6.0 (云端版)</p>
            <p>专为降低退货率设计的质检解决方案 | 数据云端共享</p>
        </footer>
    </div>

<script>
        // Supabase配置
        const SUPABASE_URL = 'https://gcbiogqxrwextckkqlpe.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_DTqj1slwdMh1xu-tnc5evA_9wz7D-W1';
        
        // 全局变量
        let fullInspectionPhotos = [];
        let sampleInspectionPhotos = {};
        let inspectionHistory = JSON.parse(localStorage.getItem('inspectionHistory')) || [];
        let returnRateHistory = JSON.parse(localStorage.getItem('returnRateHistory')) || [];
        let targetReturnRate = parseFloat(localStorage.getItem('targetReturnRate')) || 10.0;
        let supabase = null;
        let dbConnected = false;
        
        // 图表实例
        let issueChart = null;
        let returnRateChart = null;
        
        // DOM 加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM加载完成，初始化系统...');
            
            // 设置默认日期和时间
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const time = now.toTimeString().slice(0,5);
            
            document.getElementById('full-date').value = today;
            document.getElementById('full-time').value = time;
            document.getElementById('sample-date').value = today;
            document.getElementById('sample-time').value = time;
            
            // 设置目标退货率输入框
            document.getElementById('target-return-rate').value = targetReturnRate;
            
            // 标签切换功能
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    if (tabId === 'stats') {
                        updateStatistics();
                    }
                    
                    if (tabId === 'history') {
                        renderHistory();
                    }
                });
            });
            
            // 全检照片上传
            document.getElementById('full-upload-area').addEventListener('click', function() {
                document.getElementById('full-photo-input').click();
            });
            
            document.getElementById('full-photo-input').addEventListener('change', function(e) {
                handlePhotoUpload(e, 'full');
            });
            
            // 清除全检照片
            document.getElementById('clear-full-photos').addEventListener('click', function() {
                clearPhotos('full');
            });
            
            // 抽检照片上传
            document.getElementById('calculate-sample').addEventListener('click', function() {
                calculateSampleSize();
            });
            
            // 清除抽检照片
            document.getElementById('clear-sample-photos').addEventListener('click', function() {
                clearPhotos('sample');
            });
            
            // 保存全检记录
            document.getElementById('save-full-inspection').addEventListener('click', function() {
                saveFullInspection();
            });
            
            // 保存抽检记录
            document.getElementById('save-sample-inspection').addEventListener('click', function() {
                saveSampleInspection();
            });
            
            // 同步全检到云端
            document.getElementById('sync-full-to-cloud').addEventListener('click', function() {
                syncCurrentFullInspectionToCloud();
            });
            
            // 同步抽检到云端
            document.getElementById('sync-sample-to-cloud').addEventListener('click', function() {
                syncCurrentSampleInspectionToCloud();
            });
            
            // 导出Word报告
            document.getElementById('export-full-word').addEventListener('click', function() {
                generateFullInspectionReport();
            });
            
            document.getElementById('export-sample-word').addEventListener('click', function() {
                generateSamplingInspectionReport();
            });
            
            // 打印报告
            document.getElementById('print-full-report').addEventListener('click', function() {
                printFullInspectionReport();
            });
            
            document.getElementById('print-sample-report').addEventListener('click', function() {
                printSamplingInspectionReport();
            });
            
            // 历史记录操作
            document.getElementById('select-all').addEventListener('click', function() {
                document.querySelectorAll('.history-checkbox').forEach(checkbox => {
                    checkbox.checked = true;
                });
            });
            
            document.getElementById('deselect-all').addEventListener('click', function() {
                document.querySelectorAll('.history-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
            });
            
            document.getElementById('export-selected').addEventListener('click', function() {
                exportSelectedToExcel();
            });
            
            // 导入数据
            document.getElementById('import-data').addEventListener('change', function(e) {
                importData(e);
            });
            
            // 导出功能
            document.getElementById('export-excel').addEventListener('click', function() {
                exportToExcel();
            });
            
            // 清空历史记录
            document.getElementById('clear-history').addEventListener('click', function() {
                if(confirm('确定要清空所有本地历史记录吗？此操作不可撤销。')) {
                    localStorage.removeItem('inspectionHistory');
                    inspectionHistory = [];
                    renderHistory();
                    updateStatistics();
                    alert('本地历史记录已清空！');
                }
            });
            
            // 云端数据操作
            document.getElementById('load-from-cloud').addEventListener('click', function() {
                loadInspectionHistoryFromCloud();
            });
            
            document.getElementById('sync-all-to-cloud').addEventListener('click', function() {
                syncAllLocalDataToCloud();
            });
            
            document.getElementById('merge-data').addEventListener('click', function() {
                mergeCloudAndLocalData();
            });
            
            // 统计数据操作
            document.getElementById('load-stats-from-cloud').addEventListener('click', function() {
                loadInspectionHistoryFromCloud();
            });
            
            document.getElementById('data-source').addEventListener('change', function() {
                updateStatistics();
            });
            
            // 退货率相关
            document.getElementById('save-return-rate').addEventListener('click', function() {
                saveReturnRate();
            });
            
            // 同步退货率到云端
            document.getElementById('sync-return-rates').addEventListener('click', function() {
                syncReturnRatesToCloud();
            });
            
            // 设置目标退货率
            document.getElementById('set-target-rate').addEventListener('click', function() {
                setTargetReturnRate();
            });
            
            // 搜索功能
            document.getElementById('search-history').addEventListener('input', function() {
                filterHistory(this.value);
            });
            
            // 图表缩放控制
            document.getElementById('zoom-in').addEventListener('click', function() {
                zoomChart('in');
            });
            
            document.getElementById('zoom-out').addEventListener('click', function() {
                zoomChart('out');
            });
            
            document.getElementById('reset-zoom').addEventListener('click', function() {
                resetChartZoom();
            });
            
            // 初始化不合格数量输入框显示/隐藏
            initDefectQuantityInputs();
            
            // 初始化历史记录和统计数据
            renderHistory();
            updateStatistics();
            renderReturnRateHistory();
            
            // 延迟初始化Supabase连接
            setTimeout(() => {
                initSupabase();
            }, 500);
            
            console.log('系统初始化完成');
        });
        
        // 初始化Supabase连接
        async function initSupabase() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // 测试连接
                const { data, error } = await supabase
                    .from('inspection_history')
                    .select('id')
                    .limit(1);
                    
                if (error) {
                    console.warn('Supabase连接测试失败，将使用本地存储模式:', error.message);
                    updateDbStatus(false);
                    
                    // 设置一个虚拟的supabase对象，避免后续调用出错
                    supabase = {
                        from: function() {
                            return {
                                select: function() {
                                    return Promise.resolve({ data: [], error: null });
                                },
                                insert: function() {
                                    return Promise.resolve({ data: null, error: { message: '使用本地模式' } });
                                },
                                delete: function() {
                                    return Promise.resolve({ error: { message: '使用本地模式' } });
                                },
                                update: function() {
                                    return Promise.resolve({ data: null, error: { message: '使用本地模式' } });
                                }
                            };
                        }
                    };
                } else {
                    console.log('Supabase连接成功');
                    updateDbStatus(true);
                    
                    // 连接成功后，尝试从云端加载数据
                    setTimeout(() => {
                        loadInspectionHistoryFromCloud();
                        loadReturnRatesFromCloud();
                    }, 1000);
                }
            } catch (error) {
                console.error('Supabase初始化失败，将使用本地存储:', error);
                updateDbStatus(false);
                
                // 设置虚拟supabase对象
                supabase = {
                    from: function() {
                        return {
                            select: function() {
                                return Promise.resolve({ data: [], error: null });
                            },
                            insert: function() {
                                return Promise.resolve({ data: null, error: { message: '使用本地模式' } });
                            },
                            delete: function() {
                                return Promise.resolve({ error: { message: '使用本地模式' } });
                            },
                            update: function() {
                                return Promise.resolve({ data: null, error: { message: '使用本地模式' } });
                            }
                        };
                    }
                };
            }
        }
        
        // 更新数据库连接状态显示
        function updateDbStatus(connected) {
            dbConnected = connected;
            const statusElement = document.getElementById('db-status');
            const icon = statusElement.querySelector('i');
            const text = statusElement.querySelector('span');
            
            if (connected) {
                statusElement.className = 'db-status db-connected';
                icon.className = 'fas fa-database';
                text.textContent = '云端已连接';
            } else {
                statusElement.className = 'db-status db-disconnected';
                icon.className = 'fas fa-database';
                text.textContent = '本地存储模式';
            }
        }
        
        // 从云端加载检验历史记录
        async function loadInspectionHistoryFromCloud() {
            if (!dbConnected) {
                alert('云端数据库未连接，请检查网络连接！');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('inspection_history')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                if (error) {
                    console.error('从云端加载数据失败:', error);
                    alert('从云端加载数据失败: ' + error.message);
                    return;
                }
                
                if (data && data.length > 0) {
                    // 将云端数据转换为本地格式
                    const cloudHistory = data.map(item => {
                        const record = {
                            id: item.id,
                            type: item.inspection_type,
                            productSKU: item.product_sku,
                            batchNo: item.batch_no,
                            inspector: item.inspector,
                            date: item.inspection_date,
                            time: item.inspection_time,
                            result: item.result,
                            notes: item.notes || '',
                            photos: [],
                        };
                        
                        if (item.inspection_type === 'full') {
                            record.quantity = item.quantity;
                            record.passQuantity = item.pass_quantity;
                            record.defectQuantity = item.defect_quantity;
                            record.colorCheck = item.color_check;
                            record.colorDefectQuantity = item.color_defect_quantity || 0;
                            record.scratchCheck = item.scratch_check;
                            record.scratchDefectQuantity = item.scratch_defect_quantity || 0;
                            record.partsCheck = item.parts_check;
                            record.partsDefectQuantity = item.parts_defect_quantity || 0;
                            record.functionCheck = item.function_check;
                            record.functionDefectQuantity = item.function_defect_quantity || 0;
                            record.packagingCheck = item.packaging_check;
                            record.packagingDefectQuantity = item.packaging_defect_quantity || 0;
                            record.otherCheck = item.other_check;
                            record.otherDefectQuantity = item.other_defect_quantity || 0;
                        } else if (item.inspection_type === 'sampling') {
                            record.lotSize = item.lot_size;
                            record.aql = item.aql;
                            record.sampleSize = item.sample_size;
                            record.defectiveCount = item.defective_count;
                            record.acceptanceNumber = item.acceptance_number;
                            record.rejectionNumber = item.rejection_number;
                            record.sampleResults = item.sample_results || [];
                        }
                        
                        return record;
                    });
                    
                    // 更新本地数据
                    inspectionHistory = cloudHistory;
                    
                    // 更新本地存储
                    localStorage.setItem('inspectionHistory', JSON.stringify(inspectionHistory));
                    
                    // 更新显示
                    renderHistory();
                    updateStatistics();
                    
                    alert('成功从云端加载 ' + cloudHistory.length + ' 条检验记录！');
                } else {
                    alert('云端暂无检验记录数据。');
                }
            } catch (error) {
                console.error('加载云端数据异常:', error);
                alert('加载云端数据时发生异常: ' + error.message);
            }
        }
        
        // 从云端加载退货率记录
        async function loadReturnRatesFromCloud() {
            if (!dbConnected) {
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('return_rates')
                    .select('*')
                    .order('month', { ascending: true });
                    
                if (error) {
                    console.error('从云端加载退货率失败:', error);
                    return;
                }
                
                if (data && data.length > 0) {
                    // 将云端数据转换为本地格式
                    const cloudReturnRates = data.map(item => ({
                        month: item.month,
                        rate: item.rate
                    }));
                    
                    // 更新本地数据
                    returnRateHistory = cloudReturnRates;
                    
                    // 更新本地存储
                    localStorage.setItem('returnRateHistory', JSON.stringify(returnRateHistory));
                    
                    // 更新显示
                    renderReturnRateHistory();
                    updateReturnRateChart();
                }
            } catch (error) {
                console.error('加载云端退货率异常:', error);
            }
        }
        
        // 同步当前全检记录到云端
        async function syncCurrentFullInspectionToCloud() {
            if (!dbConnected) {
                alert('云端数据库未连接，无法同步！');
                return;
            }
            
            // 获取当前表单数据
            const productSKU = document.getElementById('full-product-sku').value;
            const batchNo = document.getElementById('full-batch-no').value;
            const inspector = document.getElementById('full-inspector').value;
            const date = document.getElementById('full-date').value;
            const time = document.getElementById('full-time').value;
            const quantity = parseInt(document.getElementById('full-inspection-quantity').value);
            
            if (!productSKU || !batchNo || !inspector || !quantity || quantity <= 0) {
                alert('请填写完整的产品信息！');
                return;
            }
            
            // 获取不合格数量
            const colorDefectQuantity = document.getElementById('full-color-defect-quantity').value || 0;
            const scratchDefectQuantity = document.getElementById('full-scratch-defect-quantity').value || 0;
            const partsDefectQuantity = document.getElementById('full-parts-defect-quantity').value || 0;
            const functionDefectQuantity = document.getElementById('full-function-defect-quantity').value || 0;
            const packagingDefectQuantity = document.getElementById('full-packaging-defect-quantity').value || 0;
            const otherDefectQuantity = document.getElementById('full-other-defect-quantity').value || 0;
            
            // 计算总不合格数量
            const defectQuantities = [
                parseInt(colorDefectQuantity),
                parseInt(scratchDefectQuantity),
                parseInt(partsDefectQuantity),
                parseInt(functionDefectQuantity),
                parseInt(packagingDefectQuantity),
                parseInt(otherDefectQuantity)
            ];
            
            const totalDefectQuantity = Math.max(...defectQuantities);
            
            // 计算合格数量
            const passQuantity = quantity - totalDefectQuantity;
            
            // 获取检验结果
            const colorCheck = document.getElementById('full-color-check').value;
            const scratchCheck = document.getElementById('full-scratch-check').value;
            const partsCheck = document.getElementById('full-parts-check').value;
            const functionCheck = document.getElementById('full-function-check').value;
            const packagingCheck = document.getElementById('full-packaging-check').value;
            const otherCheck = document.getElementById('full-other-check').value;
            const notes = document.getElementById('full-notes').value;
            
            const result = totalDefectQuantity === 0 ? '合格' : '不合格';
            
            // 准备上传数据
            const inspectionData = {
                inspection_type: 'full',
                product_sku: productSKU,
                batch_no: batchNo,
                inspector: inspector,
                inspection_date: date,
                inspection_time: time,
                quantity: quantity,
                pass_quantity: passQuantity,
                defect_quantity: totalDefectQuantity,
                color_check: colorCheck,
                color_defect_quantity: parseInt(colorDefectQuantity),
                scratch_check: scratchCheck,
                scratch_defect_quantity: parseInt(scratchDefectQuantity),
                parts_check: partsCheck,
                parts_defect_quantity: parseInt(partsDefectQuantity),
                function_check: functionCheck,
                function_defect_quantity: parseInt(functionDefectQuantity),
                packaging_check: packagingCheck,
                packaging_defect_quantity: parseInt(packagingDefectQuantity),
                other_check: otherCheck,
                other_defect_quantity: parseInt(otherDefectQuantity),
                notes: notes,
                result: result,
                created_at: new Date().toISOString()
            };
            
            try {
                const { data, error } = await supabase
                    .from('inspection_history')
                    .insert([inspectionData]);
                    
                if (error) {
                    console.error('同步到云端失败:', error);
                    alert('同步到云端失败: ' + error.message);
                    return;
                }
                
                alert('全检记录已成功同步到云端数据库！');
                
                // 重新从云端加载数据
                loadInspectionHistoryFromCloud();
                
            } catch (error) {
                console.error('同步到云端异常:', error);
                alert('同步到云端时发生异常: ' + error.message);
            }
        }
        
        // 同步当前抽检记录到云端
        async function syncCurrentSampleInspectionToCloud() {
            if (!dbConnected) {
                alert('云端数据库未连接，无法同步！');
                return;
            }
            
            // 获取当前表单数据
            const productSKU = document.getElementById('sample-product-sku').value;
            const batchNo = document.getElementById('sample-batch-no').value;
            const lotSize = document.getElementById('sample-lot-size').value;
            const inspector = document.getElementById('sample-inspector').value;
            const date = document.getElementById('sample-date').value;
            const time = document.getElementById('sample-time').value;
            const aql = document.getElementById('sample-aql').value;
            
            if (!productSKU || !batchNo || !lotSize || !inspector) {
                alert('请填写完整的产品信息！');
                return;
            }
            
            // 检查是否已计算样本数量
            const sampleSize = parseInt(document.getElementById('sample-size').textContent);
            if (!sampleSize || sampleSize === 0) {
                alert('请先计算抽样数量！');
                return;
            }
            
            // 收集样本检查结果
            const sampleResults = [];
            let defectiveCount = 0;
            
            document.querySelectorAll('.sample-item').forEach((item, index) => {
                const sampleIndex = index + 1;
                const colorCheck = item.querySelector('.sample-color-check').value;
                const scratchCheck = item.querySelector('.sample-scratch-check').value;
                const partsCheck = item.querySelector('.sample-parts-check').value;
                const functionCheck = item.querySelector('.sample-function-check').value;
                const packagingCheck = item.querySelector('.sample-packaging-check').value;
                const otherCheck = item.querySelector('.sample-other-check').value;
                
                const isDefective = colorCheck === '不合格' || scratchCheck === '不合格' || 
                                  partsCheck === '不合格' || functionCheck === '不合格' || 
                                  packagingCheck === '不合格' || otherCheck === '不合格';
                if (isDefective) defectiveCount++;
                
                sampleResults.push({
                    sampleIndex: sampleIndex,
                    colorCheck: colorCheck,
                    scratchCheck: scratchCheck,
                    partsCheck: partsCheck,
                    functionCheck: functionCheck,
                    packagingCheck: packagingCheck,
                    otherCheck: otherCheck,
                    result: isDefective ? '不合格' : '合格'
                });
            });
            
            // 获取AQL标准
            const acceptanceNumber = parseInt(document.getElementById('acceptance-number').textContent);
            
            // 判断批次是否合格
            const batchResult = defectiveCount <= acceptanceNumber ? '合格' : '不合格';
            
            // 准备上传数据
            const inspectionData = {
                inspection_type: 'sampling',
                product_sku: productSKU,
                batch_no: batchNo,
                inspector: inspector,
                inspection_date: date,
                inspection_time: time,
                lot_size: parseInt(lotSize),
                aql: parseFloat(aql),
                sample_size: sampleSize,
                defective_count: defectiveCount,
                acceptance_number: acceptanceNumber,
                rejection_number: parseInt(document.getElementById('rejection-number').textContent),
                sample_results: sampleResults,
                result: batchResult,
                created_at: new Date().toISOString()
            };
            
            try {
                const { data, error } = await supabase
                    .from('inspection_history')
                    .insert([inspectionData]);
                    
                if (error) {
                    console.error('同步到云端失败:', error);
                    alert('同步到云端失败: ' + error.message);
                    return;
                }
                
                alert('抽检记录已成功同步到云端数据库！缺陷数: ' + defectiveCount + ', 批次结果: ' + batchResult);
                
                // 重新从云端加载数据
                loadInspectionHistoryFromCloud();
                
            } catch (error) {
                console.error('同步到云端异常:', error);
                alert('同步到云端时发生异常: ' + error.message);
            }
        }
        
        // 同步所有本地数据到云端
        async function syncAllLocalDataToCloud() {
            if (!dbConnected) {
                alert('云端数据库未连接，无法同步！');
                return;
            }
            
            if (inspectionHistory.length === 0) {
                alert('本地没有检验记录可以同步！');
                return;
            }
            
            if (!confirm('确定要将 ' + inspectionHistory.length + ' 条本地记录同步到云端吗？')) {
                return;
            }
            
            try {
                // 转换本地数据为云端格式
                const cloudData = inspectionHistory.map(record => {
                    const cloudRecord = {
                        inspection_type: record.type,
                        product_sku: record.productSKU,
                        batch_no: record.batchNo,
                        inspector: record.inspector,
                        inspection_date: record.date,
                        inspection_time: record.time,
                        result: record.result,
                        notes: record.notes || '',
                        created_at: new Date().toISOString()
                    };
                    
                    if (record.type === 'full') {
                        cloudRecord.quantity = record.quantity;
                        cloudRecord.pass_quantity = record.passQuantity;
                        cloudRecord.defect_quantity = record.defectQuantity;
                        cloudRecord.color_check = record.colorCheck;
                        cloudRecord.color_defect_quantity = record.colorDefectQuantity || 0;
                        cloudRecord.scratch_check = record.scratchCheck;
                        cloudRecord.scratch_defect_quantity = record.scratchDefectQuantity || 0;
                        cloudRecord.parts_check = record.partsCheck;
                        cloudRecord.parts_defect_quantity = record.partsDefectQuantity || 0;
                        cloudRecord.function_check = record.functionCheck;
                        cloudRecord.function_defect_quantity = record.functionDefectQuantity || 0;
                        cloudRecord.packaging_check = record.packagingCheck;
                        cloudRecord.packaging_defect_quantity = record.packagingDefectQuantity || 0;
                        cloudRecord.other_check = record.otherCheck;
                        cloudRecord.other_defect_quantity = record.otherDefectQuantity || 0;
                    } else if (record.type === 'sampling') {
                        cloudRecord.lot_size = record.lotSize;
                        cloudRecord.aql = record.aql;
                        cloudRecord.sample_size = record.sampleSize;
                        cloudRecord.defective_count = record.defectiveCount;
                        cloudRecord.acceptance_number = record.acceptanceNumber;
                        cloudRecord.rejection_number = record.rejectionNumber;
                        cloudRecord.sample_results = record.sampleResults || [];
                    }
                    
                    return cloudRecord;
                });
                
                // 批量插入数据
                const { data, error } = await supabase
                    .from('inspection_history')
                    .insert(cloudData);
                    
                if (error) {
                    console.error('批量同步到云端失败:', error);
                    alert('批量同步到云端失败: ' + error.message);
                    return;
                }
                
                alert('成功将 ' + inspectionHistory.length + ' 条记录同步到云端数据库！');
                
                // 重新从云端加载数据
                loadInspectionHistoryFromCloud();
                
            } catch (error) {
                console.error('批量同步到云端异常:', error);
                alert('批量同步到云端时发生异常: ' + error.message);
            }
        }
        
        // 合并云端和本地数据
        async function mergeCloudAndLocalData() {
            if (!dbConnected) {
                alert('云端数据库未连接，无法合并！');
                return;
            }
            
            // 从云端加载数据
            try {
                const { data: cloudData, error } = await supabase
                    .from('inspection_history')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                if (error) {
                    console.error('从云端加载数据失败:', error);
                    alert('从云端加载数据失败: ' + error.message);
                    return;
                }
                
                if (!cloudData || cloudData.length === 0) {
                    alert('云端暂无数据，无法合并！');
                    return;
                }
                
                // 将云端数据转换为本地格式
                const cloudHistory = cloudData.map(item => {
                    const record = {
                        id: item.id,
                        type: item.inspection_type,
                        productSKU: item.product_sku,
                        batchNo: item.batch_no,
                        inspector: item.inspector,
                        date: item.inspection_date,
                        time: item.inspection_time,
                        result: item.result,
                        notes: item.notes || '',
                        photos: [],
                    };
                    
                    if (item.inspection_type === 'full') {
                        record.quantity = item.quantity;
                        record.passQuantity = item.pass_quantity;
                        record.defectQuantity = item.defect_quantity;
                        record.colorCheck = item.color_check;
                        record.colorDefectQuantity = item.color_defect_quantity || 0;
                        record.scratchCheck = item.scratch_check;
                        record.scratchDefectQuantity = item.scratch_defect_quantity || 0;
                        record.partsCheck = item.parts_check;
                        record.partsDefectQuantity = item.parts_defect_quantity || 0;
                        record.functionCheck = item.function_check;
                        record.functionDefectQuantity = item.function_defect_quantity || 0;
                        record.packagingCheck = item.packaging_check;
                        record.packagingDefectQuantity = item.packaging_defect_quantity || 0;
                        record.otherCheck = item.other_check;
                        record.otherDefectQuantity = item.other_defect_quantity || 0;
                    } else if (item.inspection_type === 'sampling') {
                        record.lotSize = item.lot_size;
                        record.aql = item.aql;
                        record.sampleSize = item.sample_size;
                        record.defectiveCount = item.defective_count;
                        record.acceptanceNumber = item.acceptance_number;
                        record.rejectionNumber = item.rejection_number;
                        record.sampleResults = item.sample_results || [];
                    }
                    
                    return record;
                });
                
                // 合并数据（避免重复）
                const localIds = inspectionHistory.map(item => item.id);
                const newCloudItems = cloudHistory.filter(item => !localIds.includes(item.id));
                
                if (newCloudItems.length === 0) {
                    alert('没有新的云端数据需要合并！');
                    return;
                }
                
                // 将新数据添加到本地
                inspectionHistory = [...inspectionHistory, ...newCloudItems];
                
                // 按日期排序
                inspectionHistory.sort((a, b) => {
                    const dateA = new Date(a.date + ' ' + a.time);
                    const dateB = new Date(b.date + ' ' + b.time);
                    return dateB - dateA;
                });
                
                // 保存到本地存储
                localStorage.setItem('inspectionHistory', JSON.stringify(inspectionHistory));
                
                // 更新显示
                renderHistory();
                updateStatistics();
                
                alert('成功合并 ' + newCloudItems.length + ' 条云端记录到本地！');
                
            } catch (error) {
                console.error('合并数据异常:', error);
                alert('合并数据时发生异常: ' + error.message);
            }
        }
        
        // 同步退货率到云端
        async function syncReturnRatesToCloud() {
            if (!dbConnected) {
                alert('云端数据库未连接，无法同步！');
                return;
            }
            
            if (returnRateHistory.length === 0) {
                alert('本地没有退货率记录可以同步！');
                return;
            }
            
            try {
                // 先清空云端退货率数据
                const { error: deleteError } = await supabase
                    .from('return_rates')
                    .delete()
                    .neq('id', 0); // 删除所有记录
                    
                if (deleteError) {
                    console.error('清空云端退货率失败:', deleteError);
                    alert('清空云端退货率失败: ' + deleteError.message);
                    return;
                }
                
                // 准备上传数据
                const cloudData = returnRateHistory.map(item => ({
                    month: item.month,
                    rate: item.rate,
                    created_at: new Date().toISOString()
                }));
                
                // 批量插入数据
                const { data, error } = await supabase
                    .from('return_rates')
                    .insert(cloudData);
                    
                if (error) {
                    console.error('同步退货率到云端失败:', error);
                    alert('同步退货率到云端失败: ' + error.message);
                    return;
                }
                
                alert('成功将 ' + returnRateHistory.length + ' 条退货率记录同步到云端！');
                
            } catch (error) {
                console.error('同步退货率到云端异常:', error);
                alert('同步退货率到云端时发生异常: ' + error.message);
            }
        }
        
        // 初始化不合格数量输入框显示/隐藏
        function initDefectQuantityInputs() {
            // 颜色色差
            document.getElementById('full-color-check').addEventListener('change', function() {
                const defectDiv = document.getElementById('full-color-defect');
                if (this.value === '不合格') {
                    defectDiv.classList.add('visible');
                } else {
                    defectDiv.classList.remove('visible');
                }
            });
            
            // 表面划痕
            document.getElementById('full-scratch-check').addEventListener('change', function() {
                const defectDiv = document.getElementById('full-scratch-defect');
                if (this.value === '不合格') {
                    defectDiv.classList.add('visible');
                } else {
                    defectDiv.classList.remove('visible');
                }
            });
            
            // 配件完整性
            document.getElementById('full-parts-check').addEventListener('change', function() {
                const defectDiv = document.getElementById('full-parts-defect');
                if (this.value === '不合格') {
                    defectDiv.classList.add('visible');
                } else {
                    defectDiv.classList.remove('visible');
                }
            });
            
            // 功能结构正确
            document.getElementById('full-function-check').addEventListener('change', function() {
                const defectDiv = document.getElementById('full-function-defect');
                if (this.value === '不合格') {
                    defectDiv.classList.add('visible');
                } else {
                    defectDiv.classList.remove('visible');
                }
            });
            
            // 包装检查
            document.getElementById('full-packaging-check').addEventListener('change', function() {
                const defectDiv = document.getElementById('full-packaging-defect');
                if (this.value === '不合格') {
                    defectDiv.classList.add('visible');
                } else {
                    defectDiv.classList.remove('visible');
                }
            });
            
            // 其他问题
            document.getElementById('full-other-check').addEventListener('change', function() {
                const defectDiv = document.getElementById('full-other-defect');
                if (this.value === '不合格') {
                    defectDiv.classList.add('visible');
                } else {
                    defectDiv.classList.remove('visible');
                }
            });
        }
        
        // 清除照片
        function clearPhotos(type) {
            if (type === 'full') {
                fullInspectionPhotos = [];
                document.getElementById('full-photo-preview').innerHTML = '';
                document.getElementById('full-photo-count').textContent = '已上传 0 张照片';
                alert('全检照片已清除！');
            } else if (type === 'sample') {
                sampleInspectionPhotos = {};
                document.querySelectorAll('.sample-photo-preview').forEach(preview => {
                    preview.innerHTML = '';
                });
                alert('抽检照片已清除！');
            }
        }
        
        // 图片压缩函数
        function compressImage(file, maxWidth = 800, maxHeight = 600, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function(event) {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // 计算缩放比例
                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round(height * maxWidth / width);
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round(width * maxHeight / height);
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // 转换为base64
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve({
                            id: Date.now() + Math.random(),
                            data: compressedDataUrl,
                            name: file.name,
                            size: (compressedDataUrl.length * 0.75) / 1024 // 估算大小(KB)
                        });
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }
        
        // 处理照片上传
        function handlePhotoUpload(event, type) {
            const files = event.target.files;
            const previewContainer = type === 'full' ? 
                document.getElementById('full-photo-preview') : 
                document.getElementById('sample-photo-preview');
                
            const photosArray = type === 'full' ? fullInspectionPhotos : sampleInspectionPhotos;
            const progressBar = type === 'full' ? 
                document.getElementById('full-progress-bar') : 
                document.getElementById('sample-progress-bar');
            const progressContainer = type === 'full' ? 
                document.getElementById('full-upload-progress') : 
                document.getElementById('sample-upload-progress');
            const photoCount = type === 'full' ? 
                document.getElementById('full-photo-count') : 
                document.getElementById('sample-photo-count');
            
            if (files.length === 0) return;
            
            // 显示上传进度
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            
            let processed = 0;
            
            // 处理每个文件
            Array.from(files).forEach((file, index) => {
                compressImage(file).then(compressedPhoto => {
                    photosArray.push(compressedPhoto);
                    
                    // 创建预览
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-item';
                    photoItem.innerHTML = `
                        <img src="${compressedPhoto.data}" alt="产品照片">
                        <div class="remove" data-id="${compressedPhoto.id}">
                            <i class="fas fa-times"></i>
                        </div>
                    `;
                    
                    previewContainer.appendChild(photoItem);
                    
                    // 添加删除事件
                    photoItem.querySelector('.remove').addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        const index = photosArray.findIndex(photo => photo.id == id);
                        if (index !== -1) {
                            photosArray.splice(index, 1);
                            photoItem.remove();
                            updatePhotoCount(type);
                        }
                    });
                    
                    // 更新进度
                    processed++;
                    const progress = (processed / files.length) * 100;
                    progressBar.style.width = `${progress}%`;
                    
                    // 更新照片计数
                    updatePhotoCount(type);
                    
                    // 完成所有处理
                    if (processed === files.length) {
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                        }, 500);
                    }
                }).catch(error => {
                    console.error('图片压缩失败:', error);
                    alert('图片 ' + file.name + ' 处理失败，请重试或选择其他图片。');
                    processed++;
                    
                    if (processed === files.length) {
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                        }, 500);
                    }
                });
            });
            
            // 重置文件输入，允许再次选择相同文件
            event.target.value = '';
        }
        
        // 更新照片计数显示
        function updatePhotoCount(type) {
            const photosArray = type === 'full' ? fullInspectionPhotos : sampleInspectionPhotos;
            const photoCount = type === 'full' ? 
                document.getElementById('full-photo-count') : 
                document.getElementById('sample-photo-count');
            
            if (photoCount) {
                photoCount.textContent = '已上传 ' + photosArray.length + ' 张照片';
            }
        }
        
        // 处理样本照片上传
        function handleSamplePhotoUpload(event, sampleIndex) {
            const files = event.target.files;
            const previewContainer = document.querySelector('.sample-photo-preview[data-sample="' + sampleIndex + '"]');
            
            // 初始化该样本的照片数组
            if (!sampleInspectionPhotos[sampleIndex]) {
                sampleInspectionPhotos[sampleIndex] = [];
            }
            
            if (files.length === 0) return;
            
            // 处理每个文件
            Array.from(files).forEach((file, index) => {
                compressImage(file).then(compressedPhoto => {
                    sampleInspectionPhotos[sampleIndex].push(compressedPhoto);
                    
                    // 创建预览
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-item';
                    photoItem.innerHTML = `
                        <img src="${compressedPhoto.data}" alt="样本照片">
                        <div class="remove" data-id="${compressedPhoto.id}" data-sample="${sampleIndex}">
                            <i class="fas fa-times"></i>
                        </div>
                    `;
                    
                    previewContainer.appendChild(photoItem);
                    
                    // 添加删除事件
                    photoItem.querySelector('.remove').addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        const sampleIdx = parseInt(this.getAttribute('data-sample'));
                        const index = sampleInspectionPhotos[sampleIdx].findIndex(photo => photo.id == id);
                        if (index !== -1) {
                            sampleInspectionPhotos[sampleIdx].splice(index, 1);
                            photoItem.remove();
                        }
                    });
                }).catch(error => {
                    console.error('样本图片压缩失败:', error);
                    alert('样本图片 ' + file.name + ' 处理失败，请重试或选择其他图片。');
                });
            });
            
            // 重置文件输入，允许再次选择相同文件
            event.target.value = '';
        }
        
        // 计算抽样数量
        function calculateSampleSize() {
            const lotSize = parseInt(document.getElementById('sample-lot-size').value);
            const aql = parseFloat(document.getElementById('sample-aql').value);
            
            if (!lotSize || lotSize <= 0) {
                alert('请输入有效的批次数量！');
                return;
            }
            
            // 简化版AQL计算逻辑
            let sampleSize, acceptanceNumber, rejectionNumber;
            
            if (lotSize <= 50) {
                sampleSize = 5;
            } else if (lotSize <= 150) {
                sampleSize = 20;
            } else if (lotSize <= 500) {
                sampleSize = 50;
            } else if (lotSize <= 1200) {
                sampleSize = 80;
            } else {
                sampleSize = 125;
            }
            
            // 根据AQL确定允收/拒收数
            if (aql === 1.0) {
                if (sampleSize <= 20) {
                    acceptanceNumber = 0;
                    rejectionNumber = 1;
                } else if (sampleSize <= 50) {
                    acceptanceNumber = 1;
                    rejectionNumber = 2;
                } else {
                    acceptanceNumber = 2;
                    rejectionNumber = 3;
                }
            } else if (aql === 2.5) {
                if (sampleSize <= 20) {
                    acceptanceNumber = 1;
                    rejectionNumber = 2;
                } else if (sampleSize <= 50) {
                    acceptanceNumber = 3;
                    rejectionNumber = 4;
                } else {
                    acceptanceNumber = 5;
                    rejectionNumber = 6;
                }
            } else { // AQL 4.0
                if (sampleSize <= 20) {
                    acceptanceNumber = 2;
                    rejectionNumber = 3;
                } else if (sampleSize <= 50) {
                    acceptanceNumber = 5;
                    rejectionNumber = 6;
                } else {
                    acceptanceNumber = 7;
                    rejectionNumber = 8;
                }
            }
            
            // 显示结果
            document.getElementById('sample-size').textContent = sampleSize;
            document.getElementById('acceptance-number').textContent = acceptanceNumber;
            document.getElementById('rejection-number').textContent = rejectionNumber;
            document.getElementById('sample-result').style.display = 'block';
            
            // 生成样本检查项
            generateSampleItems(sampleSize);
        }
        
        // 生成样本检查项
        function generateSampleItems(sampleSize) {
            const container = document.getElementById('sample-items');
            container.innerHTML = '';
            
            // 重置样本照片对象
            sampleInspectionPhotos = {};
            
            for (let i = 1; i <= sampleSize; i++) {
                const sampleItem = document.createElement('div');
                sampleItem.className = 'sample-item';
                sampleItem.innerHTML = `
                    <div class="sample-header">
                        <div class="sample-title">样本 ${i}</div>
                        <div class="sample-result pass">合格</div>
                    </div>
                    <div class="form-group">
                        <label>颜色色差</label>
                        <select class="sample-color-check">
                            <option value="合格">合格</option>
                            <option value="不合格">不合格</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>表面划痕</label>
                        <select class="sample-scratch-check">
                            <option value="合格">合格</option>
                            <option value="不合格">不合格</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>配件完整性</label>
                        <select class="sample-parts-check">
                            <option value="合格">合格</option>
                            <option value="不合格">不合格</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>功能结构正确</label>
                        <select class="sample-function-check">
                            <option value="合格">合格</option>
                            <option value="不合格">不合格</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>包装检查</label>
                        <select class="sample-packaging-check">
                            <option value="合格">合格</option>
                            <option value="不合格">不合格</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>其他问题</label>
                        <select class="sample-other-check">
                            <option value="合格">合格</option>
                            <option value="不合格">不合格</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>样本照片</label>
                        <div class="photo-upload-area sample-photo-upload" data-sample="${i}">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>点击上传样本照片</p>
                            <input type="file" class="sample-photo-input hidden" data-sample="${i}" accept="image/*" multiple>
                        </div>
                        <div class="photo-preview sample-photo-preview" data-sample="${i}">
                            <!-- 样本照片预览将在这里显示 -->
                        </div>
                    </div>
                `;
                
                container.appendChild(sampleItem);
                
                // 为样本照片上传区域添加事件
                const uploadArea = sampleItem.querySelector('.sample-photo-upload');
                const photoInput = sampleItem.querySelector('.sample-photo-input');
                
                uploadArea.addEventListener('click', function() {
                    photoInput.click();
                });
                
                photoInput.addEventListener('change', function(e) {
                    handleSamplePhotoUpload(e, i);
                });
                
                // 为每个检查项目添加事件，更新样本结果
                const checkSelects = sampleItem.querySelectorAll('select');
                checkSelects.forEach(select => {
                    select.addEventListener('change', function() {
                        updateSampleResult(sampleItem, i);
                    });
                });
            }
            
            // 显示样本检查区域
            document.getElementById('sample-items-container').style.display = 'block';
        }
        
        // 更新样本结果
        function updateSampleResult(sampleItem, sampleIndex) {
            const colorCheck = sampleItem.querySelector('.sample-color-check').value;
            const scratchCheck = sampleItem.querySelector('.sample-scratch-check').value;
            const partsCheck = sampleItem.querySelector('.sample-parts-check').value;
            const functionCheck = sampleItem.querySelector('.sample-function-check').value;
            const packagingCheck = sampleItem.querySelector('.sample-packaging-check').value;
            const otherCheck = sampleItem.querySelector('.sample-other-check').value;
            
            const isDefective = colorCheck === '不合格' || scratchCheck === '不合格' || 
                              partsCheck === '不合格' || functionCheck === '不合格' || 
                              packagingCheck === '不合格' || otherCheck === '不合格';
            
            const resultElement = sampleItem.querySelector('.sample-result');
            if (isDefective) {
                resultElement.textContent = '不合格';
                resultElement.className = 'sample-result fail';
            } else {
                resultElement.textContent = '合格';
                resultElement.className = 'sample-result pass';
            }
        }
        
        // 保存全检记录
        function saveFullInspection() {
            const productSKU = document.getElementById('full-product-sku').value;
            const batchNo = document.getElementById('full-batch-no').value;
            const inspector = document.getElementById('full-inspector').value;
            const date = document.getElementById('full-date').value;
            const time = document.getElementById('full-time').value;
            const quantity = parseInt(document.getElementById('full-inspection-quantity').value);
            
            if (!productSKU || !batchNo || !inspector || !quantity || quantity <= 0) {
                alert('请填写完整的产品信息！');
                return;
            }
            
            // 获取不合格数量
            const colorDefectQuantity = document.getElementById('full-color-defect-quantity').value || 0;
            const scratchDefectQuantity = document.getElementById('full-scratch-defect-quantity').value || 0;
            const partsDefectQuantity = document.getElementById('full-parts-defect-quantity').value || 0;
            const functionDefectQuantity = document.getElementById('full-function-defect-quantity').value || 0;
            const packagingDefectQuantity = document.getElementById('full-packaging-defect-quantity').value || 0;
            const otherDefectQuantity = document.getElementById('full-other-defect-quantity').value || 0;
            
            // 计算总不合格数量（取各项目不合格数量的最大值，因为同一产品可能有多个问题）
            const defectQuantities = [
                parseInt(colorDefectQuantity),
                parseInt(scratchDefectQuantity),
                parseInt(partsDefectQuantity),
                parseInt(functionDefectQuantity),
                parseInt(packagingDefectQuantity),
                parseInt(otherDefectQuantity)
            ];
            
            const totalDefectQuantity = Math.max(...defectQuantities);
            
            // 计算合格数量
            const passQuantity = quantity - totalDefectQuantity;
            
            const inspectionRecord = {
                id: Date.now(),
                type: 'full',
                productSKU: productSKU,
                batchNo: batchNo,
                inspector: inspector,
                date: date,
                time: time,
                quantity: quantity,
                passQuantity: passQuantity,
                defectQuantity: totalDefectQuantity,
                colorCheck: document.getElementById('full-color-check').value,
                colorDefectQuantity: parseInt(colorDefectQuantity),
                scratchCheck: document.getElementById('full-scratch-check').value,
                scratchDefectQuantity: parseInt(scratchDefectQuantity),
                partsCheck: document.getElementById('full-parts-check').value,
                partsDefectQuantity: parseInt(partsDefectQuantity),
                functionCheck: document.getElementById('full-function-check').value,
                functionDefectQuantity: parseInt(functionDefectQuantity),
                packagingCheck: document.getElementById('full-packaging-check').value,
                packagingDefectQuantity: parseInt(packagingDefectQuantity),
                otherCheck: document.getElementById('full-other-check').value,
                otherDefectQuantity: parseInt(otherDefectQuantity),
                notes: document.getElementById('full-notes').value,
                photos: [],
                result: totalDefectQuantity === 0 ? '合格' : '不合格'
            };
            
            inspectionHistory.push(inspectionRecord);
            
            try {
                localStorage.setItem('inspectionHistory', JSON.stringify(inspectionHistory));
            } catch (e) {
                alert('保存失败！可能是数据量过大，请减少记录数量。');
                console.error('保存错误:', e);
                return;
            }
            
            alert('全检记录保存成功！');
            renderHistory();
            updateStatistics();
            
            // 重置表单
            resetFullInspectionForm();
        }
        
        // 保存抽检记录
        function saveSampleInspection() {
            const productSKU = document.getElementById('sample-product-sku').value;
            const batchNo = document.getElementById('sample-batch-no').value;
            const lotSize = document.getElementById('sample-lot-size').value;
            const inspector = document.getElementById('sample-inspector').value;
            const date = document.getElementById('sample-date').value;
            const time = document.getElementById('sample-time').value;
            const aql = document.getElementById('sample-aql').value;
            
            if (!productSKU || !batchNo || !lotSize || !inspector) {
                alert('请填写完整的产品信息！');
                return;
            }
            
            // 检查是否已计算样本数量
            const sampleSize = parseInt(document.getElementById('sample-size').textContent);
            if (!sampleSize || sampleSize === 0) {
                alert('请先计算抽样数量！');
                return;
            }
            
            // 收集样本检查结果
            const sampleResults = [];
            let defectiveCount = 0;
            
            document.querySelectorAll('.sample-item').forEach((item, index) => {
                const sampleIndex = index + 1;
                const colorCheck = item.querySelector('.sample-color-check').value;
                const scratchCheck = item.querySelector('.sample-scratch-check').value;
                const partsCheck = item.querySelector('.sample-parts-check').value;
                const functionCheck = item.querySelector('.sample-function-check').value;
                const packagingCheck = item.querySelector('.sample-packaging-check').value;
                const otherCheck = item.querySelector('.sample-other-check').value;
                
                const isDefective = colorCheck === '不合格' || scratchCheck === '不合格' || 
                                  partsCheck === '不合格' || functionCheck === '不合格' || 
                                  packagingCheck === '不合格' || otherCheck === '不合格';
                if (isDefective) defectiveCount++;
                
                sampleResults.push({
                    sampleIndex: sampleIndex,
                    colorCheck: colorCheck,
                    scratchCheck: scratchCheck,
                    partsCheck: partsCheck,
                    functionCheck: functionCheck,
                    packagingCheck: packagingCheck,
                    otherCheck: otherCheck,
                    photos: [],
                    result: isDefective ? '不合格' : '合格'
                });
            });
            
            // 获取AQL标准
            const acceptanceNumber = parseInt(document.getElementById('acceptance-number').textContent);
            
            // 判断批次是否合格
            const batchResult = defectiveCount <= acceptanceNumber ? '合格' : '不合格';
            
            const inspectionRecord = {
                id: Date.now(),
                type: 'sampling',
                productSKU: productSKU,
                batchNo: batchNo,
                lotSize: parseInt(lotSize),
                inspector: inspector,
                date: date,
                time: time,
                aql: parseFloat(aql),
                sampleSize: sampleSize,
                acceptanceNumber: acceptanceNumber,
                rejectionNumber: parseInt(document.getElementById('rejection-number').textContent),
                defectiveCount: defectiveCount,
                sampleResults: sampleResults,
                result: batchResult
            };
            
            inspectionHistory.push(inspectionRecord);
            
            try {
                localStorage.setItem('inspectionHistory', JSON.stringify(inspectionHistory));
            } catch (e) {
                alert('保存失败！可能是数据量过大，请减少记录数量。');
                console.error('保存错误:', e);
                return;
            }
            
            alert('抽检记录保存成功！缺陷数: ' + defectiveCount + ', 批次结果: ' + batchResult);
            renderHistory();
            updateStatistics();
            
            // 重置表单
            resetSampleInspectionForm();
        }
        
        // 生成全检报告
        function generateFullInspectionReport() {
            const productSKU = document.getElementById('full-product-sku').value;
            const batchNo = document.getElementById('full-batch-no').value;
            const inspector = document.getElementById('full-inspector').value;
            const date = document.getElementById('full-date').value;
            const time = document.getElementById('full-time').value;
            const quantity = parseInt(document.getElementById('full-inspection-quantity').value);
            
            if (!productSKU || !batchNo || !inspector || !quantity || quantity <= 0) {
                alert('请填写完整的产品信息！');
                return;
            }
            
            const colorDefectQuantity = document.getElementById('full-color-defect-quantity').value || 0;
            const scratchDefectQuantity = document.getElementById('full-scratch-defect-quantity').value || 0;
            const partsDefectQuantity = document.getElementById('full-parts-defect-quantity').value || 0;
            const functionDefectQuantity = document.getElementById('full-function-defect-quantity').value || 0;
            const packagingDefectQuantity = document.getElementById('full-packaging-defect-quantity').value || 0;
            const otherDefectQuantity = document.getElementById('full-other-defect-quantity').value || 0;
            
            const defectQuantities = [
                parseInt(colorDefectQuantity),
                parseInt(scratchDefectQuantity),
                parseInt(partsDefectQuantity),
                parseInt(functionDefectQuantity),
                parseInt(packagingDefectQuantity),
                parseInt(otherDefectQuantity)
            ];
            
            const totalDefectQuantity = Math.max(...defectQuantities);
            const passQuantity = quantity - totalDefectQuantity;
            const reportNo = 'ELY-QC-' + new Date().getFullYear() + 
                            String(new Date().getMonth()+1).padStart(2, '0') + 
                            String(new Date().getDate()).padStart(2, '0') + '-' + 
                            Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            let photosHTML = '';
            if (fullInspectionPhotos && fullInspectionPhotos.length > 0) {
                photosHTML = `
                    <h2>不合格产品照片</h2>
                    <div class="report-photos">
                        ${fullInspectionPhotos.map(photo => `
                            <div class="report-photo-item">
                                <img src="${photo.data}" alt="不合格产品照片">
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            const colorCheck = document.getElementById('full-color-check').value;
            const scratchCheck = document.getElementById('full-scratch-check').value;
            const partsCheck = document.getElementById('full-parts-check').value;
            const functionCheck = document.getElementById('full-function-check').value;
            const packagingCheck = document.getElementById('full-packaging-check').value;
            const otherCheck = document.getElementById('full-other-check').value;
            const notes = document.getElementById('full-notes').value;
            const result = totalDefectQuantity === 0 ? '合格' : '不合格';
            
            let htmlContent = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' 
                      xmlns:w='urn:schemas-microsoft-com:office:word' 
                      xmlns='http://www.w3.org/TR/REC-html40'>
                <head>
                    <meta charset="utf-8">
                    <title>ELYONA 灯具全检验货报告</title>
                    <style>
                        body { font-family: "Microsoft YaHei", sans-serif; margin: 20px; line-height: 1.6; }
                        h1 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
                        h2 { color: #3498db; border-bottom: 1px solid #eee; padding-bottom: 5px; margin: 25px 0 15px; }
                        h3 { color: #2980b9; margin: 20px 0 10px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; box-shadow: 0 0 5px rgba(0,0,0,0.05); }
                        th, td { border: 1px solid #ddd; padding: 12px 15px; text-align: left; }
                        th { background-color: #3498db; color: white; font-weight: bold; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                        .summary { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; }
                        .signature-area { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; }
                        .signature-line { display: inline-block; width: 200px; border-bottom: 1px solid #333; margin-right: 30px; padding-bottom: 5px; }
                        .report-photos { display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; }
                        .report-photo-item { width: 150px; height: 150px; border: 1px solid #ddd; border-radius: 5px; overflow: hidden; }
                        .report-photo-item img { width: 100%; height: 100%; object-fit: cover; }
                    </style>
                </head>
                <body>
                    <h1>ELYONA 灯具全检验货报告</h1>
                    <p style="text-align: center; color: #7f8c8d;">报告编号: ${reportNo} | 生成日期: ${new Date().toLocaleDateString()}</p>
                    
                    <div class="summary">
                        <h2>产品信息</h2>
                        <table>
                            <tr>
                                <th>产品SKU</th>
                                <th>批次号</th>
                                <th>全检数量</th>
                                <th>合格数量</th>
                                <th>不合格数量</th>
                                <th>检验员</th>
                                <th>检验日期</th>
                                <th>检验结果</th>
                            </tr>
                            <tr>
                                <td>${productSKU}</td>
                                <td>${batchNo}</td>
                                <td>${quantity}</td>
                                <td>${passQuantity}</td>
                                <td>${totalDefectQuantity}</td>
                                <td>${inspector}</td>
                                <td>${date} ${time}</td>
                                <td><strong>${result}</strong></td>
                            </tr>
                        </table>
                    </div>
                    
                    <h2>检验结果详情</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>检验项目</th>
                                <th>标准要求</th>
                                <th>检验结果</th>
                                <th>不合格数量</th>
                                <th>备注</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>颜色色差</td>
                                <td>与标准样品对比，无明显色差</td>
                                <td>${colorCheck}</td>
                                <td>${colorCheck === '不合格' ? colorDefectQuantity : 0}</td>
                                <td>${colorCheck === '不合格' ? '存在明显色差' : '与标准样品一致'}</td>
                            </tr>
                            <tr>
                                <td>表面划痕</td>
                                <td>表面无划痕，光滑平整</td>
                                <td>${scratchCheck}</td>
                                <td>${scratchCheck === '不合格' ? scratchDefectQuantity : 0}</td>
                                <td>${scratchCheck === '不合格' ? '表面有明显划痕' : '表面无划痕'}</td>
                            </tr>
                            <tr>
                                <td>配件完整性</td>
                                <td>所有配件齐全，无缺失</td>
                                <td>${partsCheck}</td>
                                <td>${partsCheck === '不合格' ? partsDefectQuantity : 0}</td>
                                <td>${partsCheck === '不合格' ? '缺失配件' : '所有配件齐全'}</td>
                            </tr>
                            <tr>
                                <td>功能结构正确</td>
                                <td>功能结构正常，无异常</td>
                                <td>${functionCheck}</td>
                                <td>${functionCheck === '不合格' ? functionDefectQuantity : 0}</td>
                                <td>${functionCheck === '不合格' ? '功能结构问题' : '功能结构正常'}</td>
                            </tr>
                            <tr>
                                <td>包装检查</td>
                                <td>包装完好，标签正确</td>
                                <td>${packagingCheck}</td>
                                <td>${packagingCheck === '不合格' ? packagingDefectQuantity : 0}</td>
                                <td>${packagingCheck === '不合格' ? '包装或标签问题' : '包装完好，标签正确'}</td>
                            </tr>
                            <tr>
                                <td>其他问题</td>
                                <td>无其他问题</td>
                                <td>${otherCheck}</td>
                                <td>${otherCheck === '不合格' ? otherDefectQuantity : 0}</td>
                                <td>${otherCheck === '不合格' ? '存在其他问题' : '无其他问题'}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="form-group">
                        <h3>检验备注</h3>
                        <p>${notes || '无'}</p>
                    </div>
                    
                    ${photosHTML}
                    
                    <div class="signature-area">
                        <p>检验员签字: <span class="signature-line"></span></p>
                        <p>质检主管签字: <span class="signature-line"></span></p>
                        <p>日期: <span class="signature-line"></span></p>
                    </div>
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ELYONA_全检报告_' + productSKU + '_' + date + '.doc';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // 生成抽检报告
        function generateSamplingInspectionReport() {
            const productSKU = document.getElementById('sample-product-sku').value;
            const batchNo = document.getElementById('sample-batch-no').value;
            const lotSize = document.getElementById('sample-lot-size').value;
            const inspector = document.getElementById('sample-inspector').value;
            const date = document.getElementById('sample-date').value;
            const time = document.getElementById('sample-time').value;
            const aql = document.getElementById('sample-aql').value;
            
            if (!productSKU || !batchNo || !lotSize || !inspector) {
                alert('请填写完整的产品信息！');
                return;
            }
            
            const sampleSize = parseInt(document.getElementById('sample-size').textContent);
            if (!sampleSize || sampleSize === 0) {
                alert('请先计算抽样数量！');
                return;
            }
            
            const reportNo = 'ELY-QC-' + new Date().getFullYear() + 
                            String(new Date().getMonth()+1).padStart(2, '0') + 
                            String(new Date().getDate()).padStart(2, '0') + '-' + 
                            Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            const sampleResults = [];
            let defectiveCount = 0;
            
            document.querySelectorAll('.sample-item').forEach((item, index) => {
                const sampleIndex = index + 1;
                const colorCheck = item.querySelector('.sample-color-check').value;
                const scratchCheck = item.querySelector('.sample-scratch-check').value;
                const partsCheck = item.querySelector('.sample-parts-check').value;
                const functionCheck = item.querySelector('.sample-function-check').value;
                const packagingCheck = item.querySelector('.sample-packaging-check').value;
                const otherCheck = item.querySelector('.sample-other-check').value;
                
                const isDefective = colorCheck === '不合格' || scratchCheck === '不合格' || 
                                  partsCheck === '不合格' || functionCheck === '不合格' || 
                                  packagingCheck === '不合格' || otherCheck === '不合格';
                if (isDefective) defectiveCount++;
                
                const samplePhotos = sampleInspectionPhotos[sampleIndex] ? [...sampleInspectionPhotos[sampleIndex]] : [];
                
                sampleResults.push({
                    sampleIndex: sampleIndex,
                    colorCheck: colorCheck,
                    scratchCheck: scratchCheck,
                    partsCheck: partsCheck,
                    functionCheck: functionCheck,
                    packagingCheck: packagingCheck,
                    otherCheck: otherCheck,
                    photos: samplePhotos,
                    result: isDefective ? '不合格' : '合格'
                });
            });
            
            const acceptanceNumber = parseInt(document.getElementById('acceptance-number').textContent);
            const batchResult = defectiveCount <= acceptanceNumber ? '合格' : '不合格';
            const defectRate = (defectiveCount / sampleSize * 100).toFixed(2);
            
            let defectiveSamplesHTML = '';
            const defectiveSamples = sampleResults.filter(sample => sample.result === '不合格');
            
            if (defectiveSamples.length > 0) {
                defectiveSamplesHTML = `
                    <h2>不合格样本详情</h2>
                    ${defectiveSamples.map(sample => {
                        let samplePhotosHTML = '';
                        if (sample.photos && sample.photos.length > 0) {
                            samplePhotosHTML = `
                                <h4>样本 ${sample.sampleIndex} 照片</h4>
                                <div class="report-photos">
                                    ${sample.photos.map(photo => `
                                        <div class="report-photo-item">
                                            <img src="${photo.data}" alt="样本照片">
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }
                        
                        return `
                            <div style="margin-bottom: 30px; border: 1px solid #eee; padding: 15px; border-radius: 5px;">
                                <h3>样本 ${sample.sampleIndex}</h3>
                                <table>
                                    <tr>
                                        <th>检验项目</th>
                                        <th>检验结果</th>
                                    </tr>
                                    <tr>
                                        <td>颜色色差</td>
                                        <td>${sample.colorCheck}</td>
                                    </tr>
                                    <tr>
                                        <td>表面划痕</td>
                                        <td>${sample.scratchCheck}</td>
                                    </tr>
                                    <tr>
                                        <td>配件完整性</td>
                                        <td>${sample.partsCheck}</td>
                                    </tr>
                                    <tr>
                                        <td>功能结构正确</td>
                                        <td>${sample.functionCheck}</td>
                                    </tr>
                                    <tr>
                                        <td>包装检查</td>
                                        <td>${sample.packagingCheck}</td>
                                    </tr>
                                    <tr>
                                        <td>其他问题</td>
                                        <td>${sample.otherCheck}</td>
                                    </tr>
                                </table>
                                ${samplePhotosHTML}
                            </div>
                        `;
                    }).join('')}
                `;
            }
            
            let htmlContent = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' 
                      xmlns:w='urn:schemas-microsoft-com:office:word' 
                      xmlns='http://www.w3.org/TR/REC-html40'>
                <head>
                    <meta charset="utf-8">
                    <title>ELYONA 灯具抽检验货报告</title>
                    <style>
                        body { font-family: "Microsoft YaHei", sans-serif; margin: 20px; line-height: 1.6; }
                        h1 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
                        h2 { color: #3498db; border-bottom: 1px solid #eee; padding-bottom: 5px; margin: 25px 0 15px; }
                        h3 { color: #2980b9; margin: 20px 0 10px; }
                        h4 { color: #2c3e50; margin: 15px 0 10px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; box-shadow: 0 0 5px rgba(0,0,0,0.05); }
                        th, td { border: 1px solid #ddd; padding: 12px 15px; text-align: left; }
                        th { background-color: #3498db; color: white; font-weight: bold; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                        .summary { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; }
                        .signature-area { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; }
                        .signature-line { display: inline-block; width: 200px; border-bottom: 1px solid #333; margin-right: 30px; padding-bottom: 5px; }
                        .report-photos { display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; }
                        .report-photo-item { width: 150px; height: 150px; border: 1px solid #ddd; border-radius: 5px; overflow: hidden; }
                        .report-photo-item img { width: 100%; height: 100%; object-fit: cover; }
                    </style>
                </head>
                <body>
                    <h1>ELYONA 灯具抽检验货报告</h1>
                    <p style="text-align: center; color: #7f8c8d;">报告编号: ${reportNo} | 生成日期: ${new Date().toLocaleDateString()}</p>
                    
                    <div class="summary">
                        <h2>产品信息</h2>
                        <table>
                            <tr>
                                <th>产品SKU</th>
                                <th>批次号</th>
                                <th>批次数量</th>
                                <th>检验员</th>
                                <th>检验日期</th>
                                <th>检验结果</th>
                            </tr>
                            <tr>
                                <td>${productSKU}</td>
                                <td>${batchNo}</td>
                                <td>${lotSize}</td>
                                <td>${inspector}</td>
                                <td>${date} ${time}</td>
                                <td><strong>${batchResult}</strong></td>
                            </tr>
                        </table>
                    </div>
                    
                    <h2>抽样计划</h2>
                    <table>
                        <tr>
                            <th>AQL标准</th>
                            <th>样本数量</th>
                            <th>允收数(Ac)</th>
                            <th>拒收数(Re)</th>
                            <th>缺陷数量</th>
                            <th>缺陷率</th>
                        </tr>
                        <tr>
                            <td>${aql}</td>
                            <td>${sampleSize}</td>
                            <td>${acceptanceNumber}</td>
                            <td>${parseInt(document.getElementById('rejection-number').textContent)}</td>
                            <td>${defectiveCount}</td>
                            <td>${defectRate}%</td>
                        </tr>
                    </table>
                    
                    <h2>批次判定</h2>
                    <table>
                        <tr>
                            <th>判定标准</th>
                            <th>实际结果</th>
                            <th>批次判定</th>
                        </tr>
                        <tr>
                            <td>缺陷数 ≤ ${acceptanceNumber}</td>
                            <td>缺陷数 = ${defectiveCount}</td>
                            <td><strong>${batchResult}</strong></td>
                        </tr>
                    </table>
                    
                    ${defectiveSamplesHTML}
                    
                    <div class="signature-area">
                        <p>检验员签字: <span class="signature-line"></span></p>
                        <p>质检主管签字: <span class="signature-line"></span></p>
                        <p>日期: <span class="signature-line"></span></p>
                    </div>
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ELYONA_抽检报告_' + productSKU + '_' + date + '.doc';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // 打印全检报告
        function printFullInspectionReport() {
            const productSKU = document.getElementById('full-product-sku').value;
            const batchNo = document.getElementById('full-batch-no').value;
            const inspector = document.getElementById('full-inspector').value;
            const date = document.getElementById('full-date').value;
            const time = document.getElementById('full-time').value;
            const quantity = parseInt(document.getElementById('full-inspection-quantity').value);
            
            if (!productSKU || !batchNo || !inspector || !quantity || quantity <= 0) {
                alert('请填写完整的产品信息！');
                return;
            }
            
            const colorDefectQuantity = document.getElementById('full-color-defect-quantity').value || 0;
            const scratchDefectQuantity = document.getElementById('full-scratch-defect-quantity').value || 0;
            const partsDefectQuantity = document.getElementById('full-parts-defect-quantity').value || 0;
            const functionDefectQuantity = document.getElementById('full-function-defect-quantity').value || 0;
            const packagingDefectQuantity = document.getElementById('full-packaging-defect-quantity').value || 0;
            const otherDefectQuantity = document.getElementById('full-other-defect-quantity').value || 0;
            
            const defectQuantities = [
                parseInt(colorDefectQuantity),
                parseInt(scratchDefectQuantity),
                parseInt(partsDefectQuantity),
                parseInt(functionDefectQuantity),
                parseInt(packagingDefectQuantity),
                parseInt(otherDefectQuantity)
            ];
            
            const totalDefectQuantity = Math.max(...defectQuantities);
            const passQuantity = quantity - totalDefectQuantity;
            const reportNo = 'ELY-QC-' + new Date().getFullYear() + 
                            String(new Date().getMonth()+1).padStart(2, '0') + 
                            String(new Date().getDate()).padStart(2, '0') + '-' + 
                            Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            let photosHTML = '';
            if (fullInspectionPhotos && fullInspectionPhotos.length > 0) {
                photosHTML = `
                    <h2>不合格产品照片</h2>
                    <div class="report-photos">
                        ${fullInspectionPhotos.map(photo => `
                            <div class="report-photo-item">
                                <img src="${photo.data}" alt="不合格产品照片">
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            const colorCheck = document.getElementById('full-color-check').value;
            const scratchCheck = document.getElementById('full-scratch-check').value;
            const partsCheck = document.getElementById('full-parts-check').value;
            const functionCheck = document.getElementById('full-function-check').value;
            const packagingCheck = document.getElementById('full-packaging-check').value;
            const otherCheck = document.getElementById('full-other-check').value;
            const notes = document.getElementById('full-notes').value;
            const result = totalDefectQuantity === 0 ? '合格' : '不合格';
            
            const printContent = `
                <div class="print-section">
                    <h1>ELYONA 灯具全检验货报告</h1>
                    <p style="text-align: center; color: #7f8c8d;">报告编号: ${reportNo} | 生成日期: ${new Date().toLocaleDateString()}</p>
                    
                    <div class="summary">
                        <h2>产品信息</h2>
                        <table>
                            <tr>
                                <th>产品SKU</th>
                                <th>批次号</th>
                                <th>全检数量</th>
                                <th>合格数量</th>
                                <th>不合格数量</th>
                                <th>检验员</th>
                                <th>检验日期</th>
                                <th>检验结果</th>
                            </tr>
                            <tr>
                                <td>${productSKU}</td>
                                <td>${batchNo}</td>
                                <td>${quantity}</td>
                                <td>${passQuantity}</td>
                                <td>${totalDefectQuantity}</td>
                                <td>${inspector}</td>
                                <td>${date} ${time}</td>
                                <td><strong>${result}</strong></td>
                            </tr>
                        </table>
                    </div>
                    
                    <h2>检验结果详情</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>检验项目</th>
                                <th>标准要求</th>
                                <th>检验结果</th>
                                <th>不合格数量</th>
                                <th>备注</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>颜色色差</td>
                                <td>与标准样品对比，无明显色差</td>
                                <td>${colorCheck}</td>
                                <td>${colorCheck === '不合格' ? colorDefectQuantity : 0}</td>
                                <td>${colorCheck === '不合格' ? '存在明显色差' : '与标准样品一致'}</td>
                            </tr>
                            <tr>
                                <td>表面划痕</td>
                                <td>表面无划痕，光滑平整</td>
                                <td>${scratchCheck}</td>
                                <td>${scratchCheck === '不合格' ? scratchDefectQuantity : 0}</td>
                                <td>${scratchCheck === '不合格' ? '表面有明显划痕' : '表面无划痕'}</td>
                            </tr>
                            <tr>
                                <td>配件完整性</td>
                                <td>所有配件齐全，无缺失</td>
                                <td>${partsCheck}</td>
                                <td>${partsCheck === '不合格' ? partsDefectQuantity : 0}</td>
                                <td>${partsCheck === '不合格' ? '缺失配件' : '所有配件齐全'}</td>
                            </tr>
                            <tr>
                                <td>功能结构正确</td>
                                <td>功能结构正常，无异常</td>
                                <td>${functionCheck}</td>
                                <td>${functionCheck === '不合格' ? functionDefectQuantity : 0}</td>
                                <td>${functionCheck === '不合格' ? '功能结构问题' : '功能结构正常'}</td>
                            </tr>
                            <tr>
                                <td>包装检查</td>
                                <td>包装完好，标签正确</td>
                                <td>${packagingCheck}</td>
                                <td>${packagingCheck === '不合格' ? packagingDefectQuantity : 0}</td>
                                <td>${packagingCheck === '不合格' ? '包装或标签问题' : '包装完好，标签正确'}</td>
                            </tr>
                            <tr>
                                <td>其他问题</td>
                                <td>无其他问题</td>
                                <td>${otherCheck}</td>
                                <td>${otherCheck === '不合格' ? otherDefectQuantity : 0}</td>
                                <td>${otherCheck === '不合格' ? '存在其他问题' : '无其他问题'}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="form-group">
                        <h3>检验备注</h3>
                        <p>${notes || '无'}</p>
                    </div>
                    
                    ${photosHTML}
                    
                    <div class="signature-area">
                        <p>检验员签字: <span class="signature-line"></span></p>
                        <p>质检主管签字: <span class="signature-line"></span></p>
                        <p>日期: <span class="signature-line"></span></p>
                    </div>
                </div>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>ELYONA 灯具全检验货报告</title>
                        <style>
                            body { font-family: "Microsoft YaHei", sans-serif; margin: 20px; line-height: 1.6; }
                            h1 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
                            h2 { color: #3498db; border-bottom: 1px solid #eee; padding-bottom: 5px; margin: 25px 0 15px; }
                            h3 { color: #2980b9; margin: 20px 0 10px; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; box-shadow: 0 0 5px rgba(0,0,0,0.05); }
                            th, td { border: 1px solid #ddd; padding: 12px 15px; text-align: left; }
                            th { background-color: #3498db; color: white; font-weight: bold; }
                            tr:nth-child(even) { background-color: #f9f9f9; }
                            .summary { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; }
                            .signature-area { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; }
                            .signature-line { display: inline-block; width: 200px; border-bottom: 1px solid #333; margin-right: 30px; padding-bottom: 5px; }
                            .report-photos { display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; }
                            .report-photo-item { width: 150px; height: 150px; border: 1px solid #ddd; border-radius: 5px; overflow: hidden; }
                            .report-photo-item img { width: 100%; height: 100%; object-fit: cover; }
                        </style>
                    </head>
                    <body>
                        ${printContent}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }
        
        // 打印抽检报告
        function printSamplingInspectionReport() {
            const productSKU = document.getElementById('sample-product-sku').value;
            const batchNo = document.getElementById('sample-batch-no').value;
            const lotSize = document.getElementById('sample-lot-size').value;
            const inspector = document.getElementById('sample-inspector').value;
            const date = document.getElementById('sample-date').value;
            const time = document.getElementById('sample-time').value;
            const aql = document.getElementById('sample-aql').value;
            
            if (!productSKU || !batchNo || !lotSize || !inspector) {
                alert('请填写完整的产品信息！');
                return;
            }
            
            const sampleSize = parseInt(document.getElementById('sample-size').textContent);
            if (!sampleSize || sampleSize === 0) {
                alert('请先计算抽样数量！');
                return;
            }
            
            const reportNo = 'ELY-QC-' + new Date().getFullYear() + 
                            String(new Date().getMonth()+1).padStart(2, '0') + 
                            String(new Date().getDate()).padStart(2, '0') + '-' + 
                            Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            const sampleResults = [];
            let defectiveCount = 0;
            
            document.querySelectorAll('.sample-item').forEach((item, index) => {
                const sampleIndex = index + 1;
                const colorCheck = item.querySelector('.sample-color-check').value;
                const scratchCheck = item.querySelector('.sample-scratch-check').value;
                const partsCheck = item.querySelector('.sample-parts-check').value;
                const functionCheck = item.querySelector('.sample-function-check').value;
                const packagingCheck = item.querySelector('.sample-packaging-check').value;
                const otherCheck = item.querySelector('.sample-other-check').value;
                
                const isDefective = colorCheck === '不合格' || scratchCheck === '不合格' || 
                                  partsCheck === '不合格' || functionCheck === '不合格' || 
                                  packagingCheck === '不合格' || otherCheck === '不合格';
                if (isDefective) defectiveCount++;
                
                const samplePhotos = sampleInspectionPhotos[sampleIndex] ? [...sampleInspectionPhotos[sampleIndex]] : [];
                
                sampleResults.push({
                    sampleIndex: sampleIndex,
                    colorCheck: colorCheck,
                    scratchCheck: scratchCheck,
                    partsCheck: partsCheck,
                    functionCheck: functionCheck,
                    packagingCheck: packagingCheck,
                    otherCheck: otherCheck,
                    photos: samplePhotos,
                    result: isDefective ? '不合格' : '合格'
                });
            });
            
            const acceptanceNumber = parseInt(document.getElementById('acceptance-number').textContent);
            const batchResult = defectiveCount <= acceptanceNumber ? '合格' : '不合格';
            const defectRate = (defectiveCount / sampleSize * 100).toFixed(2);
            
            let defectiveSamplesHTML = '';
            const defectiveSamples = sampleResults.filter(sample => sample.result === '不合格');
            
            if (defectiveSamples.length > 0) {
                defectiveSamplesHTML = `
                    <h2>不合格样本详情</h2>
                    ${defectiveSamples.map(sample => {
                        let samplePhotosHTML = '';
                        if (sample.photos && sample.photos.length > 0) {
                            samplePhotosHTML = `
                                <h4>样本 ${sample.sampleIndex} 照片</h4>
                                <div class="report-photos">
                                    ${sample.photos.map(photo => `
                                        <div class="report-photo-item">
                                            <img src="${photo.data}" alt="样本照片">
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }
                        
                        return `
                            <div style="margin-bottom: 30px; border: 1px solid #eee; padding: 15px; border-radius: 5px;">
                                <h3>样本 ${sample.sampleIndex}</h3>
                                <table>
                                    <tr>
                                        <th>检验项目</th>
                                        <th>检验结果</th>
                                    </tr>
                                    <tr>
                                        <td>颜色色差</td>
                                        <td>${sample.colorCheck}</td>
                                    </tr>
                                    <tr>
                                        <td>表面划痕</td>
                                        <td>${sample.scratchCheck}</td>
                                    </tr>
                                    <tr>
                                        <td>配件完整性</td>
                                        <td>${sample.partsCheck}</td>
                                    </tr>
                                    <tr>
                                        <td>功能结构正确</td>
                                        <td>${sample.functionCheck}</td>
                                    </tr>
                                    <tr>
                                        <td>包装检查</td>
                                        <td>${sample.packagingCheck}</td>
                                    </tr>
                                    <tr>
                                        <td>其他问题</td>
                                        <td>${sample.otherCheck}</td>
                                    </tr>
                                </table>
                                ${samplePhotosHTML}
                            </div>
                        `;
                    }).join('')}
                `;
            }
            
            const printContent = `
                <div class="print-section">
                    <h1>ELYONA 灯具抽检验货报告</h1>
                    <p style="text-align: center; color: #7f8c8d;">报告编号: ${reportNo} | 生成日期: ${new Date().toLocaleDateString()}</p>
                    
                    <div class="summary">
                        <h2>产品信息</h2>
                        <table>
                            <tr>
                                <th>产品SKU</th>
                                <th>批次号</th>
                                <th>批次数量</th>
                                <th>检验员</th>
                                <th>检验日期</th>
                                <th>检验结果</th>
                            </tr>
                            <tr>
                                <td>${productSKU}</td>
                                <td>${batchNo}</td>
                                <td>${lotSize}</td>
                                <td>${inspector}</td>
                                <td>${date} ${time}</td>
                                <td><strong>${batchResult}</strong></td>
                            </tr>
                        </table>
                    </div>
                    
                    <h2>抽样计划</h2>
                    <table>
                        <tr>
                            <th>AQL标准</th>
                            <th>样本数量</th>
                            <th>允收数(Ac)</th>
                            <th>拒收数(Re)</th>
                            <th>缺陷数量</th>
                            <th>缺陷率</th>
                        </tr>
                        <tr>
                            <td>${aql}</td>
                            <td>${sampleSize}</td>
                            <td>${acceptanceNumber}</td>
                            <td>${parseInt(document.getElementById('rejection-number').textContent)}</td>
                            <td>${defectiveCount}</td>
                            <td>${defectRate}%</td>
                        </tr>
                    </table>
                    
                    <h2>批次判定</h2>
                    <table>
                        <tr>
                            <th>判定标准</th>
                            <th>实际结果</th>
                            <th>批次判定</th>
                        </tr>
                        <tr>
                            <td>缺陷数 ≤ ${acceptanceNumber}</td>
                            <td>缺陷数 = ${defectiveCount}</td>
                            <td><strong>${batchResult}</strong></td>
                        </tr>
                    </table>
                    
                    ${defectiveSamplesHTML}
                    
                    <div class="signature-area">
                        <p>检验员签字: <span class="signature-line"></span></p>
                        <p>质检主管签字: <span class="signature-line"></span></p>
                        <p>日期: <span class="signature-line"></span></p>
                    </div>
                </div>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>ELYONA 灯具抽检验货报告</title>
                        <style>
                            body { font-family: "Microsoft YaHei", sans-serif; margin: 20px; line-height: 1.6; }
                            h1 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
                            h2 { color: #3498db; border-bottom: 1px solid #eee; padding-bottom: 5px; margin: 25px 0 15px; }
                            h3 { color: #2980b9; margin: 20px 0 10px; }
                            h4 { color: #2c3e50; margin: 15px 0 10px; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; box-shadow: 0 0 5px rgba(0,0,0,0.05); }
                            th, td { border: 1px solid #ddd; padding: 12px 15px; text-align: left; }
                            th { background-color: #3498db; color: white; font-weight: bold; }
                            tr:nth-child(even) { background-color: #f9f9f9; }
                            .summary { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; }
                            .signature-area { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; }
                            .signature-line { display: inline-block; width: 200px; border-bottom: 1px solid #333; margin-right: 30px; padding-bottom: 5px; }
                            .report-photos { display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; }
                            .report-photo-item { width: 150px; height: 150px; border: 1px solid #ddd; border-radius: 5px; overflow: hidden; }
                            .report-photo-item img { width: 100%; height: 100%; object-fit: cover; }
                        </style>
                    </head>
                    <body>
                        ${printContent}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }
        
        // 重置全检表单
        function resetFullInspectionForm() {
            document.getElementById('full-product-sku').value = '';
            document.getElementById('full-batch-no').value = '';
            document.getElementById('full-inspection-quantity').value = '';
            document.getElementById('full-inspector').value = '';
            document.getElementById('full-color-check').value = '合格';
            document.getElementById('full-scratch-check').value = '合格';
            document.getElementById('full-parts-check').value = '合格';
            document.getElementById('full-function-check').value = '合格';
            document.getElementById('full-packaging-check').value = '合格';
            document.getElementById('full-other-check').value = '合格';
            document.getElementById('full-notes').value = '';
            
            document.getElementById('full-color-defect-quantity').value = '';
            document.getElementById('full-scratch-defect-quantity').value = '';
            document.getElementById('full-parts-defect-quantity').value = '';
            document.getElementById('full-function-defect-quantity').value = '';
            document.getElementById('full-packaging-defect-quantity').value = '';
            document.getElementById('full-other-defect-quantity').value = '';
            
            document.getElementById('full-color-defect').classList.remove('visible');
            document.getElementById('full-scratch-defect').classList.remove('visible');
            document.getElementById('full-parts-defect').classList.remove('visible');
            document.getElementById('full-function-defect').classList.remove('visible');
            document.getElementById('full-packaging-defect').classList.remove('visible');
            document.getElementById('full-other-defect').classList.remove('visible');
            
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const time = now.toTimeString().slice(0,5);
            
            document.getElementById('full-date').value = today;
            document.getElementById('full-time').value = time;
        }
        
        // 重置抽检表单
        function resetSampleInspectionForm() {
            document.getElementById('sample-product-sku').value = '';
            document.getElementById('sample-batch-no').value = '';
            document.getElementById('sample-lot-size').value = '';
            document.getElementById('sample-inspector').value = '';
            document.getElementById('sample-aql').value = '2.5';
            
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const time = now.toTimeString().slice(0,5);
            
            document.getElementById('sample-date').value = today;
            document.getElementById('sample-time').value = time;
            
            document.getElementById('sample-result').style.display = 'none';
            document.getElementById('sample-items-container').style.display = 'none';
        }
        
        // 渲染历史记录
        function renderHistory() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            if (inspectionHistory.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: #7f8c8d;">暂无检验记录</p>';
                return;
            }
            
            const sortedHistory = [...inspectionHistory].sort((a, b) => {
                const dateA = new Date(a.date + ' ' + a.time);
                const dateB = new Date(b.date + ' ' + b.time);
                return dateB - dateA;
            });
            
            sortedHistory.forEach(record => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const badgeClass = record.type === 'full' ? 'badge-success' : 'badge-warning';
                const resultBadgeClass = record.result === '合格' ? 'badge-success' : 'badge-danger';
                
                historyItem.innerHTML = `
                    <input type="checkbox" class="history-checkbox" data-id="${record.id}">
                    <div class="history-content">
                        <div class="history-header">
                            <div class="history-title">${record.productSKU}</div>
                            <span class="badge ${badgeClass}">${record.type === 'full' ? '全检' : '抽检'}</span>
                        </div>
                        <div class="history-details">
                            <div>批次: ${record.batchNo}</div>
                            <div>检验员: ${record.inspector}</div>
                            <div>日期: ${record.date} ${record.time}</div>
                            <div>结果: <span class="badge ${resultBadgeClass}">${record.result}</span></div>
                        </div>
                    </div>
                `;
                
                historyList.appendChild(historyItem);
            });
        }
        
        // 过滤历史记录
        function filterHistory(searchTerm) {
            const historyItems = document.querySelectorAll('.history-item');
            
            historyItems.forEach(item => {
                const title = item.querySelector('.history-title').textContent;
                const details = item.querySelector('.history-details').textContent;
                const text = title + ' ' + details;
                
                if (text.toLowerCase().includes(searchTerm.toLowerCase())) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // 导入数据
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonData.length === 0) {
                        alert('导入的文件中没有数据！');
                        return;
                    }
                    
                    const importedRecords = jsonData.map(item => {
                        const record = {
                            id: Date.now() + Math.random(),
                            type: item['检验类型'] === '全检' ? 'full' : 'sampling',
                            productSKU: item['产品SKU'] || '',
                            batchNo: item['批次号'] || '',
                            inspector: item['检验员'] || '',
                            date: item['检验日期'] || new Date().toISOString().split('T')[0],
                            time: item['检验时间'] || '00:00',
                            colorCheck: item['颜色检查'] || '合格',
                            colorDefectQuantity: item['颜色不合格数量'] || 0,
                            scratchCheck: item['表面划痕'] || '合格',
                            scratchDefectQuantity: item['表面划痕不合格数量'] || 0,
                            partsCheck: item['配件检查'] || '合格',
                            partsDefectQuantity: item['配件不合格数量'] || 0,
                            functionCheck: item['功能结构'] || '合格',
                            functionDefectQuantity: item['功能结构不合格数量'] || 0,
                            packagingCheck: item['包装检查'] || '合格',
                            packagingDefectQuantity: item['包装不合格数量'] || 0,
                            otherCheck: item['其他问题'] || '合格',
                            otherDefectQuantity: item['其他问题不合格数量'] || 0,
                            notes: item['备注'] || '',
                            result: item['检验结果'] || '合格',
                            photos: []
                        };
                        
                        if (record.type === 'full') {
                            record.quantity = item['全检数量'] || 1;
                            record.passQuantity = item['合格数量'] || 1;
                            record.defectQuantity = item['不合格数量'] || 0;
                        }
                        
                        if (record.type === 'sampling') {
                            record.lotSize = item['批次数量'] || 0;
                            record.aql = item['AQL标准'] || 2.5;
                            record.sampleSize = item['样本数量'] || 0;
                            record.defectiveCount = item['缺陷数量'] || 0;
                            record.acceptanceNumber = item['允收数'] || 0;
                            record.rejectionNumber = item['拒收数'] || 0;
                            
                            if (item['样本结果']) {
                                record.sampleResults = JSON.parse(item['样本结果']);
                            }
                        }
                        
                        return record;
                    });
                    
                    inspectionHistory = [...inspectionHistory, ...importedRecords];
                    inspectionHistory.sort((a, b) => {
                        const dateA = new Date(a.date + ' ' + a.time);
                        const dateB = new Date(b.date + ' ' + b.time);
                        return dateB - dateA;
                    });
                    
                    localStorage.setItem('inspectionHistory', JSON.stringify(inspectionHistory));
                    renderHistory();
                    updateStatistics();
                    
                    alert('成功导入 ' + importedRecords.length + ' 条记录！');
                    
                } catch (error) {
                    console.error('导入数据错误:', error);
                    alert('导入数据失败，请检查文件格式是否正确！');
                }
            };
            
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }
        
        // 导出选中记录到Excel
        function exportSelectedToExcel() {
            const selectedIds = [];
            document.querySelectorAll('.history-checkbox:checked').forEach(checkbox => {
                selectedIds.push(parseInt(checkbox.getAttribute('data-id')));
            });
            
            if (selectedIds.length === 0) {
                alert('请先选择要导出的记录！');
                return;
            }
            
            const selectedRecords = inspectionHistory.filter(record => selectedIds.includes(record.id));
            exportRecordsToExcel(selectedRecords, '选中记录');
        }
        
        // 导出全部记录到Excel
        function exportToExcel() {
            if (inspectionHistory.length === 0) {
                alert('没有可导出的数据！');
                return;
            }
            
            exportRecordsToExcel(inspectionHistory, '全部记录');
        }
        
        // 导出记录到Excel
        function exportRecordsToExcel(records, sheetName) {
            const wb = XLSX.utils.book_new();
            const excelData = records.map(record => {
                const baseData = {
                    '检验类型': record.type === 'full' ? '全检' : '抽检',
                    '产品SKU': record.productSKU,
                    '批次号': record.batchNo,
                    '检验员': record.inspector,
                    '检验日期': record.date,
                    '检验时间': record.time,
                    '颜色检查': record.colorCheck,
                    '颜色不合格数量': record.colorDefectQuantity || 0,
                    '表面划痕': record.scratchCheck,
                    '表面划痕不合格数量': record.scratchDefectQuantity || 0,
                    '配件检查': record.partsCheck,
                    '配件不合格数量': record.partsDefectQuantity || 0,
                    '功能结构': record.functionCheck,
                    '功能结构不合格数量': record.functionDefectQuantity || 0,
                    '包装检查': record.packagingCheck,
                    '包装不合格数量': record.packagingDefectQuantity || 0,
                    '其他问题': record.otherCheck,
                    '其他问题不合格数量': record.otherDefectQuantity || 0,
                    '检验结果': record.result,
                    '备注': record.notes,
                    '照片数量': record.photos ? record.photos.length : 0
                };
                
                if (record.type === 'full') {
                    baseData['全检数量'] = record.quantity || 1;
                    baseData['合格数量'] = record.passQuantity || 1;
                    baseData['不合格数量'] = record.defectQuantity || 0;
                }
                
                if (record.type === 'sampling') {
                    baseData['批次数量'] = record.lotSize;
                    baseData['AQL标准'] = record.aql;
                    baseData['样本数量'] = record.sampleSize;
                    baseData['缺陷数量'] = record.defectiveCount;
                    baseData['允收数'] = record.acceptanceNumber;
                    baseData['拒收数'] = record.rejectionNumber;
                    
                    if (record.sampleResults) {
                        baseData['样本结果'] = JSON.stringify(record.sampleResults);
                    }
                }
                
                return baseData;
            });
            
            const ws = XLSX.utils.json_to_sheet(excelData);
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, 'ELYONA_质检记录_' + new Date().toISOString().split('T')[0] + '.xlsx');
        }
        
        // 更新统计数据
        function updateStatistics() {
            const dataSource = document.getElementById('data-source').value;
            let dataToUse = inspectionHistory;
            
            if (dataSource === 'cloud' && !dbConnected) {
                alert('云端数据库未连接，使用本地数据。');
                document.getElementById('data-source').value = 'local';
            }
            
            const now = new Date();
            const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthStr = lastMonth.getFullYear() + '-' + String(lastMonth.getMonth() + 1).padStart(2, '0');
            
            const currentMonthData = dataToUse.filter(record => record.date.startsWith(currentMonth));
            const lastMonthData = dataToUse.filter(record => record.date.startsWith(lastMonthStr));
            
            let currentMonthTotal = 0;
            let currentMonthPassed = 0;
            let currentMonthDefects = 0;
            
            currentMonthData.forEach(record => {
                if (record.type === 'full') {
                    currentMonthTotal += record.quantity || 1;
                    currentMonthPassed += record.passQuantity || 0;
                    currentMonthDefects += record.defectQuantity || 0;
                } else if (record.type === 'sampling') {
                    currentMonthTotal += record.sampleSize || 0;
                    currentMonthPassed += (record.sampleSize || 0) - (record.defectiveCount || 0);
                    currentMonthDefects += record.defectiveCount || 0;
                }
            });
            
            let lastMonthTotal = 0;
            let lastMonthPassed = 0;
            let lastMonthDefects = 0;
            
            lastMonthData.forEach(record => {
                if (record.type === 'full') {
                    lastMonthTotal += record.quantity || 1;
                    lastMonthPassed += record.passQuantity || 0;
                    lastMonthDefects += record.defectQuantity || 0;
                } else if (record.type === 'sampling') {
                    lastMonthTotal += record.sampleSize || 0;
                    lastMonthPassed += (record.sampleSize || 0) - (record.defectiveCount || 0);
                    lastMonthDefects += record.defectiveCount || 0;
                }
            });
            
            const totalChange = lastMonthTotal > 0 ? ((currentMonthTotal - lastMonthTotal) / lastMonthTotal * 100).toFixed(1) : 0;
            
            document.getElementById('current-month-total').textContent = currentMonthTotal;
            document.getElementById('month-total-change').textContent = '比上月 ' + (totalChange >= 0 ? '+' : '') + totalChange + '%';
            
            const currentPassRate = currentMonthTotal > 0 ? (currentMonthPassed / currentMonthTotal * 100).toFixed(1) : 0;
            const lastPassRate = lastMonthTotal > 0 ? (lastMonthPassed / lastMonthTotal * 100).toFixed(1) : 0;
            const passRateChange = lastPassRate > 0 ? (parseFloat(currentPassRate) - parseFloat(lastPassRate)).toFixed(1) : 0;
            
            document.getElementById('pass-rate').textContent = currentPassRate + '%';
            document.getElementById('pass-rate-change').textContent = '比上月 ' + (passRateChange >= 0 ? '+' : '') + passRateChange + '%';
            
            const currentDefectRate = currentMonthTotal > 0 ? (currentMonthDefects / currentMonthTotal * 100).toFixed(1) : 0;
            const lastDefectRate = lastMonthTotal > 0 ? (lastMonthDefects / lastMonthTotal * 100).toFixed(1) : 0;
            const defectRateChange = lastDefectRate > 0 ? (parseFloat(currentDefectRate) - parseFloat(lastDefectRate)).toFixed(1) : 0;
            
            const defectCountChange = lastMonthDefects > 0 ? ((currentMonthDefects - lastMonthDefects) / lastMonthDefects * 100).toFixed(1) : 0;
            
            document.getElementById('defect-count').textContent = currentMonthDefects;
            document.getElementById('defect-count-change').textContent = '比上月 ' + (defectCountChange >= 0 ? '+' : '') + defectCountChange + '%';
            document.getElementById('defect-rate').textContent = currentDefectRate + '%';
            document.getElementById('defect-rate-change').textContent = '比上月 ' + (defectRateChange >= 0 ? '+' : '') + defectRateChange + '%';
            
            updateIssueStatistics(currentMonthData);
            updateReturnRateChart();
        }
        
        // 更新问题统计
        function updateIssueStatistics(data) {
            const issueStats = {
                '颜色色差': 0,
                '表面划痕': 0,
                '配件完整性': 0,
                '功能结构正确': 0,
                '包装检查': 0,
                '其他': 0
            };
            
            data.forEach(record => {
                if (record.type === 'full') {
                    if (record.colorCheck === '不合格') issueStats['颜色色差'] += record.colorDefectQuantity || 0;
                    if (record.scratchCheck === '不合格') issueStats['表面划痕'] += record.scratchDefectQuantity || 0;
                    if (record.partsCheck === '不合格') issueStats['配件完整性'] += record.partsDefectQuantity || 0;
                    if (record.functionCheck === '不合格') issueStats['功能结构正确'] += record.functionDefectQuantity || 0;
                    if (record.packagingCheck === '不合格') issueStats['包装检查'] += record.packagingDefectQuantity || 0;
                    if (record.otherCheck === '不合格') issueStats['其他'] += record.otherDefectQuantity || 0;
                } else if (record.type === 'sampling') {
                    if (record.sampleResults) {
                        record.sampleResults.forEach(sample => {
                            if (sample.colorCheck === '不合格') issueStats['颜色色差']++;
                            if (sample.scratchCheck === '不合格') issueStats['表面划痕']++;
                            if (sample.partsCheck === '不合格') issueStats['配件完整性']++;
                            if (sample.functionCheck === '不合格') issueStats['功能结构正确']++;
                            if (sample.packagingCheck === '不合格') issueStats['包装检查']++;
                            if (sample.otherCheck === '不合格') issueStats['其他']++;
                        });
                    }
                }
            });
            
            const issueList = document.getElementById('issue-list');
            issueList.innerHTML = '';
            
            const totalIssues = Object.values(issueStats).reduce((sum, count) => sum + count, 0);
            
            Object.entries(issueStats).forEach(([issue, count]) => {
                const percentage = totalIssues > 0 ? ((count / totalIssues) * 100).toFixed(1) : 0;
                const issueItem = document.createElement('li');
                issueItem.className = 'issue-item';
                issueItem.innerHTML = `
                    <span class="issue-name">${issue}</span>
                    <span class="issue-count">${count} (${percentage}%)</span>
                `;
                issueList.appendChild(issueItem);
            });
            
            updateIssueChart(issueStats);
        }
        
        // 更新问题饼图
        function updateIssueChart(issueStats) {
            const ctx = document.getElementById('issueChart').getContext('2d');
            
            const labels = Object.keys(issueStats);
            const data = Object.values(issueStats);
            const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
            
            if (issueChart) {
                issueChart.destroy();
            }
            
            issueChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return label + ': ' + value + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 更新退货率趋势图
        function updateReturnRateChart() {
            const ctx = document.getElementById('returnRateChart').getContext('2d');
            
            const sortedHistory = [...returnRateHistory].sort((a, b) => a.month.localeCompare(b.month));
            const labels = sortedHistory.map(item => item.month);
            const data = sortedHistory.map(item => parseFloat(item.rate));
            
            const targetData = labels.map(() => targetReturnRate);
            
            const minWidth = 600;
            const itemWidth = 80;
            const chartWidth = Math.max(minWidth, labels.length * itemWidth);
            
            document.getElementById('return-rate-chart-wrapper').style.minWidth = chartWidth + 'px';
            
            if (returnRateChart) {
                returnRateChart.destroy();
            }
            
            returnRateChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '实际退货率 (%)',
                            data: data,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 3,
                            pointHoverRadius: 6
                        },
                        {
                            label: '目标退货率 (%)',
                            data: targetData,
                            borderColor: '#3498db',
                            borderDash: [5, 5],
                            backgroundColor: 'transparent',
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 20
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: Math.max(...data, targetReturnRate, 10) + 5,
                            title: {
                                display: true,
                                text: '退货率 (%)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '退货率趋势图 (全部数据)'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 图表缩放控制
        function zoomChart(direction) {
            if (!returnRateChart) return;
            
            if (direction === 'in') {
                // 简单缩放逻辑
                const canvas = document.getElementById('returnRateChart');
                const container = document.getElementById('return-rate-chart-wrapper');
                const currentWidth = parseInt(container.style.minWidth) || 600;
                container.style.minWidth = (currentWidth * 1.2) + 'px';
            } else if (direction === 'out') {
                const canvas = document.getElementById('returnRateChart');
                const container = document.getElementById('return-rate-chart-wrapper');
                const currentWidth = parseInt(container.style.minWidth) || 600;
                container.style.minWidth = (currentWidth * 0.8) + 'px';
            }
        }
        
        // 重置图表缩放
        function resetChartZoom() {
            const sortedHistory = [...returnRateHistory].sort((a, b) => a.month.localeCompare(b.month));
            const minWidth = 600;
            const itemWidth = 80;
            const chartWidth = Math.max(minWidth, sortedHistory.length * itemWidth);
            
            document.getElementById('return-rate-chart-wrapper').style.minWidth = chartWidth + 'px';
        }
        
        // 保存退货率记录
        function saveReturnRate() {
            const month = document.getElementById('return-rate-month').value;
            const rate = parseFloat(document.getElementById('return-rate-value').value);
            
            if (!month || isNaN(rate)) {
                alert('请填写完整的月份和退货率！');
                return;
            }
            
            const existingIndex = returnRateHistory.findIndex(item => item.month === month);
            
            if (existingIndex !== -1) {
                returnRateHistory[existingIndex].rate = rate;
            } else {
                returnRateHistory.push({
                    month: month,
                    rate: rate
                });
            }
            
            returnRateHistory.sort((a, b) => a.month.localeCompare(b.month));
            localStorage.setItem('returnRateHistory', JSON.stringify(returnRateHistory));
            
            alert('退货率记录保存成功！');
            document.getElementById('return-rate-value').value = '';
            renderReturnRateHistory();
            updateReturnRateChart();
        }
        
        // 设置目标退货率
        function setTargetReturnRate() {
            const targetRate = parseFloat(document.getElementById('target-return-rate').value);
            
            if (isNaN(targetRate) || targetRate < 0 || targetRate > 100) {
                alert('请输入有效的目标退货率 (0-100)');
                return;
            }
            
            targetReturnRate = targetRate;
            localStorage.setItem('targetReturnRate', targetReturnRate);
            
            alert('目标退货率已更新！');
            updateReturnRateChart();
        }
        
        // 渲染退货率历史记录
        function renderReturnRateHistory() {
            const historyContainer = document.getElementById('return-rate-history');
            historyContainer.innerHTML = '';
            
            if (returnRateHistory.length === 0) {
                historyContainer.innerHTML = '<p style="text-align: center; padding: 10px; color: #7f8c8d;">暂无退货率记录</p>';
                return;
            }
            
            const sortedHistory = [...returnRateHistory].sort((a, b) => b.month.localeCompare(a.month));
            
            sortedHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'return-rate-item';
                
                historyItem.innerHTML = `
                    <span>${item.month}</span>
                    <span style="font-weight: bold; color: ${item.rate > targetReturnRate ? '#e74c3c' : '#2ecc71'}">${item.rate}%</span>
                `;
                
                historyContainer.appendChild(historyItem);
            });
        }
    </script>
</body>
</html>