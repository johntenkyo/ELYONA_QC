<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELYONA灯具质检系统 (云端版)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* 保持原有基础样式 */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color: #333; min-height: 100vh; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); overflow: hidden; }
        header { background: #2c3e50; color: white; padding: 20px; text-align: center; position: relative; }
        .logo { font-size: 24px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .logo i { color: #3498db; }
        .app-version { position: absolute; top: 10px; right: 15px; font-size: 12px; opacity: 0.7; }
        .nav-tabs { display: flex; background: #34495e; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; transition: all 0.3s; font-weight: 600; color: #ecf0f1; }
        .tab.active { background: #3498db; color: white; }
        .tab:hover:not(.active) { background: #3e5871; }
        .tab-content { display: none; padding: 20px; min-height: 500px; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
        input, select, textarea { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; transition: all 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: #3498db; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); outline: none; }
        .btn { display: inline-block; background: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; text-align: center; height: 38px; line-height: 18px; }
        .btn:hover { background: #2980b9; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        .btn-block { display: block; width: 100%; margin-top: 10px;}
        .btn-success { background: #2ecc71; } .btn-success:hover { background: #27ae60; }
        .btn-danger { background: #e74c3c; } .btn-danger:hover { background: #c0392b; }
        .btn-warning { background: #f39c12; } .btn-warning:hover { background: #e67e22; }
        .card { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #3498db; }
        .card h3 { margin-bottom: 15px; color: #2c3e50; display: flex; align-items: center; gap: 10px; }
        
        /* 布局样式优化 */
        .time-selector, .stats, .issue-stats { display: grid; gap: 15px; }
        .time-selector { grid-template-columns: 1fr 1fr; }
        .stats { grid-template-columns: 1fr 1fr; margin: 20px 0; }
        .issue-stats { grid-template-columns: 1fr 1fr; }
        .stat-card { background: white; border-radius: 10px; padding: 20px; text-align: center; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08); }
        .stat-value { font-size: 32px; font-weight: bold; margin: 10px 0; }
        .stat-success { color: #2ecc71; } .stat-danger { color: #e74c3c; }
        .stat-label { font-size: 14px; color: #7f8c8d; }

        /* 历史记录和列表样式 */
        .history-item { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08); border-left: 4px solid #3498db; display: flex; align-items: center; gap: 15px; }
        .history-content { flex: 1; }
        .history-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .history-title { font-weight: 600; color: #2c3e50; }
        .history-details { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px; color: #7f8c8d; }
        
        /* 针对图表滚动的优化 */
        .chart-container {
            height: 350px;
            margin: 20px 0;
            position: relative;
            overflow-x: auto; /* 允许横向滚动 */
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
        }
        .chart-wrapper {
            min-width: 100%; /* 默认占满 */
            height: 100%;
            /* 宽度将由JS动态设置以适应数据量 */
        }
        
        /* 针对退货率列表滚动的优化 */
        .return-rate-history {
            max-height: 400px; /* 增加高度限制 */
            overflow-y: auto; /* 允许纵向滚动 */
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        .return-rate-item { display: flex; justify-content: space-between; padding: 12px 10px; border-bottom: 1px solid #f5f5f5; }
        .return-rate-item:last-child { border-bottom: none; }
        .return-rate-item:hover { background-color: #f0f7ff; }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8); z-index: 9999;
            display: none; justify-content: center; align-items: center;
            font-size: 20px; font-weight: bold; color: #3498db;
        }

        /* 其他辅助样式 */
        .hidden { display: none; }
        .badge { padding: 3px 8px; border-radius: 12px; font-size: 12px; }
        .badge-success { background: #d5f4e6; color: #27ae60; }
        .badge-danger { background: #fadbd8; color: #e74c3c; }
        
        @media (max-width: 768px) {
            .time-selector, .stats, .issue-stats, .history-details { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading">数据同步中...</div>
    <div class="container">
        <header>
            <div class="logo"><i class="fas fa-lightbulb"></i> ELYONA灯具质检系统</div>
            <div class="app-version">v3.0.0 Cloud</div>
        </header>
        
        <div class="nav-tabs">
            <div class="tab active" data-tab="full-inspection">全检</div>
            <div class="tab" data-tab="sampling-inspection">抽检</div>
            <div class="tab" data-tab="history">历史记录</div>
            <div class="tab" data-tab="stats">数据统计</div>
        </div>
        
        <div class="tab-content active" id="full-inspection">
            <h2>全检验货</h2>
            <div class="card">
                <h3><i class="fas fa-info-circle"></i> 产品信息</h3>
                <div class="form-group"><label>产品SKU</label><input type="text" id="full-product-sku"></div>
                <div class="form-group"><label>批次号</label><input type="text" id="full-batch-no"></div>
                <div class="form-group"><label>全检数量</label><input type="number" id="full-inspection-quantity"></div>
                <div class="form-group"><label>检验员</label><input type="text" id="full-inspector"></div>
                <div class="time-selector">
                    <div class="form-group"><label>日期</label><input type="date" id="full-date"></div>
                    <div class="form-group"><label>时间</label><input type="time" id="full-time"></div>
                </div>
            </div>
            <div class="card">
                <h3><i class="fas fa-clipboard-check"></i> 检验结果概览</h3>
                <div class="form-group">
                    <label>各项目不合格数量 (默认为0)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="number" id="full-color-defect" placeholder="色差不合格数">
                        <input type="number" id="full-scratch-defect" placeholder="划痕不合格数">
                        <input type="number" id="full-parts-defect" placeholder="配件不合格数">
                        <input type="number" id="full-function-defect" placeholder="功能不合格数">
                        <input type="number" id="full-packaging-defect" placeholder="包装不合格数">
                        <input type="number" id="full-other-defect" placeholder="其他不合格数">
                    </div>
                </div>
                <div class="form-group"><label>备注</label><textarea id="full-notes" rows="2"></textarea></div>
            </div>
            <button class="btn btn-success btn-block" id="save-full-inspection"><i class="fas fa-cloud-upload-alt"></i> 保存并上传记录</button>
        </div>
        
        <div class="tab-content" id="sampling-inspection">
            <h2>抽检验货</h2>
            <div class="card">
                <div class="form-group"><label>产品SKU</label><input type="text" id="sample-product-sku"></div>
                <div class="form-group"><label>批次号</label><input type="text" id="sample-batch-no"></div>
                <div class="form-group"><label>批次总量</label><input type="number" id="sample-lot-size"></div>
                <div class="form-group"><label>抽样数</label><input type="number" id="sample-size-input" placeholder="输入抽检数量"></div>
                <div class="form-group"><label>不合格品数</label><input type="number" id="sample-defect-count" placeholder="发现的不良品总数"></div>
                <div class="form-group"><label>检验结果</label>
                    <select id="sample-result-status">
                        <option value="合格">合格</option>
                        <option value="不合格">不合格</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-success btn-block" id="save-sample-inspection"><i class="fas fa-cloud-upload-alt"></i> 保存并上传记录</button>
        </div>
        
        <div class="tab-content" id="history">
            <h2><i class="fas fa-history"></i> 云端历史记录</h2>
            <div class="history-actions">
                <div class="form-group" style="flex: 1;"><input type="text" id="search-history" placeholder="搜索 SKU 或 批次号..."></div>
                <button class="btn" id="refresh-data"><i class="fas fa-sync"></i> 刷新数据</button>
            </div>
            <div id="history-list"></div>
        </div>
        
        <div class="tab-content" id="stats">
            <h2>质检数据驾驶舱</h2>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">本月检验总量</div>
                    <div class="stat-value" id="current-month-total">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">本月合格率</div>
                    <div class="stat-value stat-success" id="pass-rate">0%</div>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-chart-line"></i> 退货率趋势 (可左右滑动查看全部)</h3>
                <div class="chart-container">
                    <div class="chart-wrapper">
                        <canvas id="returnRateChart"></canvas>
                    </div>
                </div>
                <div class="form-group" style="display: flex; gap: 10px; margin-top: 15px;">
                    <input type="number" id="target-return-rate" placeholder="目标退货率 (%)" style="flex: 1;">
                    <button class="btn" id="set-target-rate">设置目标</button>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-list"></i> 月度退货率记录 (滚动查看所有)</h3>
                <div class="form-group" style="display: flex; gap: 10px;">
                    <input type="month" id="return-rate-month">
                    <input type="number" id="return-rate-value" placeholder="退货率 %" step="0.01">
                    <button class="btn btn-success" id="save-return-rate">保存</button>
                </div>
                <div class="return-rate-history" id="return-rate-history">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // ================= 配置区域 =================
        // 请将你在 Supabase 获取的 URL 和 Key 填入此处
        const SUPABASE_URL = 'https://gcbiogqxrwextckkqlpe.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjYmlvZ3F4cndleHRja2txbHBlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MDU2MTYsImV4cCI6MjA4MDE4MTYxNn0.cFas_nlTKCEG6AKQKRe0ufqLEpOi6lI8p--zeqh9_mk';
        // ==========================================

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 全局状态
        let inspectionHistory = [];
        let returnRateHistory = [];
        let targetReturnRate = 2.0;
        let myChart = null;

        // 初始化
        window.addEventListener('DOMContentLoaded', async () => {
            setupTabs();
            setupDateInputs();
            await loadAllData(); // 从云端加载数据
            
            // 绑定保存按钮
            document.getElementById('save-full-inspection').onclick = saveFullInspection;
            document.getElementById('save-sample-inspection').onclick = saveSampleInspection;
            document.getElementById('save-return-rate').onclick = saveReturnRate;
            document.getElementById('set-target-rate').onclick = saveTargetRate;
            document.getElementById('refresh-data').onclick = loadAllData;
            document.getElementById('search-history').oninput = function(e) { filterHistory(e.target.value); };
        });

        // 标签页切换
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                    if (tab.dataset.tab === 'stats' || tab.dataset.tab === 'history') {
                        // 切换到统计或历史时重新渲染
                        renderHistory();
                        updateStatistics();
                    }
                });
            });
        }

        function setupDateInputs() {
            const today = new Date().toISOString().split('T')[0];
            const now = new Date().toTimeString().split(' ')[0].substring(0, 5);
            ['full-date'].forEach(id => document.getElementById(id).value = today);
            ['full-time'].forEach(id => document.getElementById(id).value = now);
        }

        // ================= 核心数据逻辑 (Supabase) =================

        async function loadAllData() {
            showLoading(true);
            try {
                // 1. 获取质检记录
                const { data: inspections, error: err1 } = await supabase
                    .from('inspections')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (err1) throw err1;
                
                // 转换数据格式适配现有逻辑
                inspectionHistory = inspections.map(row => row.data);

                // 2. 获取退货率
                const { data: rates, error: err2 } = await supabase
                    .from('return_rates')
                    .select('*')
                    .order('month', { ascending: false });

                if (err2) throw err2;
                returnRateHistory = rates.map(r => ({ month: r.month, rate: parseFloat(r.rate) }));

                // 3. 获取目标设置
                const { data: settings } = await supabase
                    .from('settings')
                    .select('*')
                    .eq('key', 'target_return_rate')
                    .single();
                
                if (settings) {
                    targetReturnRate = parseFloat(settings.value);
                    document.getElementById('target-return-rate').value = targetReturnRate;
                }

                renderHistory();
                renderReturnRateHistory();
                updateStatistics();
                alert('云端数据同步成功！');

            } catch (error) {
                console.error(error);
                alert('数据加载失败，请检查网络或配置: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function saveFullInspection() {
            const data = {
                id: Date.now().toString(),
                type: 'full',
                productSKU: document.getElementById('full-product-sku').value,
                batchNo: document.getElementById('full-batch-no').value,
                inspector: document.getElementById('full-inspector').value,
                date: document.getElementById('full-date').value,
                quantity: parseInt(document.getElementById('full-inspection-quantity').value || 0),
                defects: {
                    color: parseInt(document.getElementById('full-color-defect').value || 0),
                    scratch: parseInt(document.getElementById('full-scratch-defect').value || 0),
                    parts: parseInt(document.getElementById('full-parts-defect').value || 0),
                    func: parseInt(document.getElementById('full-function-defect').value || 0),
                    pack: parseInt(document.getElementById('full-packaging-defect').value || 0),
                    other: parseInt(document.getElementById('full-other-defect').value || 0)
                },
                notes: document.getElementById('full-notes').value
            };

            if (!data.productSKU || !data.batchNo) return alert('请填写SKU和批次号');

            showLoading(true);
            const { error } = await supabase.from('inspections').insert([{
                record_id: data.id,
                type: 'full',
                product_sku: data.productSKU,
                batch_no: data.batchNo,
                inspector: data.inspector,
                inspection_date: data.date,
                data: data
            }]);
            
            showLoading(false);
            if (error) alert('保存失败: ' + error.message);
            else {
                alert('全检记录已上传云端');
                loadAllData();
            }
        }

        async function saveSampleInspection() {
            const data = {
                id: Date.now().toString(),
                type: 'sampling',
                productSKU: document.getElementById('sample-product-sku').value,
                batchNo: document.getElementById('sample-batch-no').value,
                lotSize: parseInt(document.getElementById('sample-lot-size').value || 0),
                sampleSize: parseInt(document.getElementById('sample-size-input').value || 0),
                defectCount: parseInt(document.getElementById('sample-defect-count').value || 0),
                result: document.getElementById('sample-result-status').value,
                date: new Date().toISOString().split('T')[0]
            };

            if (!data.productSKU) return alert('请填写信息');

            showLoading(true);
            const { error } = await supabase.from('inspections').insert([{
                record_id: data.id,
                type: 'sampling',
                product_sku: data.productSKU,
                batch_no: data.batchNo,
                inspection_date: data.date,
                data: data
            }]);
            
            showLoading(false);
            if (error) alert('保存失败');
            else {
                alert('抽检记录已上传');
                loadAllData();
            }
        }

        async function saveReturnRate() {
            const month = document.getElementById('return-rate-month').value;
            const rate = parseFloat(document.getElementById('return-rate-value').value);
            
            if (!month || isNaN(rate)) return alert('请输入有效月份和数值');

            showLoading(true);
            // 先删除旧的同月数据(覆盖逻辑)，再插入
            await supabase.from('return_rates').delete().eq('month', month);
            const { error } = await supabase.from('return_rates').insert([{ month, rate }]);
            
            showLoading(false);
            if (error) alert('保存失败');
            else {
                document.getElementById('return-rate-value').value = '';
                loadAllData();
            }
        }

        async function saveTargetRate() {
            const rate = document.getElementById('target-return-rate').value;
            await supabase.from('settings').upsert({ key: 'target_return_rate', value: rate });
            alert('目标已更新');
            targetReturnRate = rate;
            updateReturnRateChart();
        }

        // ================= 渲染与统计 =================

        function renderHistory() {
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            inspectionHistory.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                const isPass = item.type === 'sampling' ? item.result === '合格' : true; // 全检默认视为完成
                div.innerHTML = `
                    <div class="history-content">
                        <div class="history-header">
                            <span class="history-title">${item.productSKU} <span class="badge ${item.type==='full'?'badge-warning':'badge-success'}">${item.type==='full'?'全检':'抽检'}</span></span>
                            <span class="badge ${isPass?'badge-success':'badge-danger'}">${item.type==='sampling'?item.result:'已完成'}</span>
                        </div>
                        <div class="history-details">
                            <span>批次: ${item.batchNo}</span>
                            <span>日期: ${item.date}</span>
                            <span>检验员: ${item.inspector || '-'}</span>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function filterHistory(keyword) {
            const items = document.querySelectorAll('.history-item');
            keyword = keyword.toLowerCase();
            items.forEach(item => {
                item.style.display = item.textContent.toLowerCase().includes(keyword) ? 'flex' : 'none';
            });
        }

        function renderReturnRateHistory() {
            const container = document.getElementById('return-rate-history');
            container.innerHTML = '';
            // 排序：月份倒序
            const sorted = [...returnRateHistory].sort((a, b) => b.month.localeCompare(a.month));
            
            // 【修改点】不再 slice(0,6)，而是显示全部，CSS 负责滚动
            sorted.forEach(item => {
                const div = document.createElement('div');
                div.className = 'return-rate-item';
                div.innerHTML = `
                    <span>${item.month}</span>
                    <span style="font-weight:bold; color: ${item.rate > targetReturnRate ? '#e74c3c' : '#2ecc71'}">${item.rate}%</span>
                `;
                container.appendChild(div);
            });
            updateReturnRateChart();
        }

        function updateReturnRateChart() {
            const ctx = document.getElementById('returnRateChart').getContext('2d');
            // 按月份正序排列用于图表
            const sortedData = [...returnRateHistory].sort((a, b) => a.month.localeCompare(b.month));
            
            // 【修改点】动态计算宽度，实现横向滚动
            // 每个数据点预留 60px 宽度，或者至少占满容器
            const minWidth = 600;
            const dynamicWidth = Math.max(minWidth, sortedData.length * 60);
            document.querySelector('.chart-wrapper').style.width = `${dynamicWidth}px`;

            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedData.map(d => d.month),
                    datasets: [{
                        label: '实际退货率 (%)',
                        data: sortedData.map(d => d.rate),
                        borderColor: '#3498db',
                        tension: 0.3,
                        fill: true,
                        backgroundColor: 'rgba(52, 152, 219, 0.1)'
                    }, {
                        label: '目标退货率',
                        data: Array(sortedData.length).fill(targetReturnRate),
                        borderColor: '#e74c3c',
                        borderDash: [5, 5],
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 10 } // 假设退货率不会超过10%，可调整
                    },
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });
        }

        function updateStatistics() {
            // 简单统计逻辑示例
            const currentMonth = new Date().toISOString().substring(0, 7);
            const thisMonthRecords = inspectionHistory.filter(r => r.date.startsWith(currentMonth));
            document.getElementById('current-month-total').textContent = thisMonthRecords.length;
            
            // 计算合格率逻辑(略简化)
            let passCount = thisMonthRecords.filter(r => r.type === 'sampling' && r.result === '合格' || r.type === 'full').length;
            let rate = thisMonthRecords.length ? ((passCount / thisMonthRecords.length) * 100).toFixed(1) : 0;
            document.getElementById('pass-rate').textContent = rate + '%';
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>